<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnitCV Pro - Universal Converter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Configuration for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        /* --- DARK MODE SELECT FIX --- */
        /* Forces proper contrast for dropdown options in Dark Mode */
        option {
            background-color: #ffffff;
            color: #1e293b;
        }
        .dark option {
            background-color: #1e293b; /* Dark Slate Background */
            color: #f1f5f9; /* Light Text */
        }

        /* --- VIEW UTILITIES --- */
        .view-section {
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .view-section.active {
            display: grid; /* or block depending on layout */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- ROBUST PRINT STYLES --- */
        @media print {
            /* 1. Hide everything by default using visibility */
            body * {
                visibility: hidden;
            }

            /* 2. Make the history section visible */
            #history-section, #history-section * {
                visibility: visible;
            }

            /* 3. Position the history section at the very top of the printed page */
            #history-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                height: auto !important;
                max-height: none !important;
                background: white !important;
                color: black !important;
            }

            /* 4. Ensure the container expands fully */
            #history-container {
                height: auto !important;
                overflow: visible !important;
            }

            /* 5. Hide the action buttons inside the visible section */
            #history-actions, .fa-trash-can, #clear-history {
                display: none !important;
            }

            /* 6. Formatting fixes for print */
            body { 
                background: white; 
                height: auto;
                overflow: visible;
            }
            
            /* Add a print-only title */
            #history-section::before {
                content: "Conversion History Report";
                display: block;
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 20px;
                text-align: center;
                border-bottom: 2px solid #eee;
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="switchView('home')">
                <div class="bg-brand-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-layer-group"></i> 
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">UnitCV <span class="text-brand-500">Pro</span></h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Back to Home Button (Visible only when not on home) -->
                <button id="home-btn" onclick="switchView('home')" class="hidden text-sm font-medium text-slate-500 hover:text-brand-600 transition-colors items-center gap-2">
                    <i class="fa-solid fa-house"></i> <span class="hidden sm:inline">Home</span>
                </button>

                <div id="auth-status" class="hidden md:flex items-center text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full">
                    <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2 animate-pulse" id="auth-dot"></span>
                    <span id="auth-text">Connecting...</span>
                </div>
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-300">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- AdSense Slot 1 (Header) -->
    <div class="ad-slot max-w-4xl mx-auto px-4 mt-4">
        <div class="w-full h-24 bg-gray-200 dark:bg-slate-800 border-2 border-dashed border-gray-300 dark:border-slate-700 rounded-lg flex flex-col items-center justify-center text-gray-400 text-sm">
            <span class="font-semibold">Google AdSense</span>
            <span>Header Banner (Responsive)</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-4xl mx-auto px-4 py-6 w-full relative">
        
        <!-- VIEW 1: HOME DASHBOARD -->
        <div id="view-home" class="view-section active grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Unit Converter Card -->
            <div onclick="switchView('converter')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-brand-500 dark:hover:border-brand-500 transition-all cursor-pointer group">
                <div class="bg-brand-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-brand-600 dark:text-brand-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-arrow-right-arrow-left text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Unit Converter</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Convert Length, Weight, Volume, Temperature and more.</p>
            </div>

            <!-- Physics Calculator Card (Active) -->
            <div onclick="switchView('physics')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-purple-500 dark:hover:border-purple-500 transition-all cursor-pointer group relative overflow-hidden">
                <div class="bg-purple-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-purple-600 dark:text-purple-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-atom text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Physics</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Calculate Speed, Force, Work, Energy, and Power.</p>
            </div>

            <!-- Financial Calculator Card (Placeholder) -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-green-500 dark:hover:border-green-500 transition-all cursor-pointer group relative overflow-hidden">
                <div class="absolute top-3 right-3 bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded-full">SOON</div>
                <div class="bg-green-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-green-600 dark:text-green-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-sack-dollar text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Finance</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Loan payments, Interest rates, and Investment returns.</p>
            </div>

            <!-- Health Calculator Card (Placeholder) -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-red-500 dark:hover:border-red-500 transition-all cursor-pointer group relative overflow-hidden">
                <div class="absolute top-3 right-3 bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded-full">SOON</div>
                <div class="bg-red-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-red-600 dark:text-red-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-heart-pulse text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Health</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">BMI, BMR, Body Fat Percentage and Calorie needs.</p>
            </div>
        </div>

        <!-- VIEW 2: UNIT CONVERTER -->
        <div id="view-converter" class="view-section gap-6 md:grid-cols-12">
            <!-- Converter Section -->
            <div id="converter-section" class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg">Converter</h2>
                        <select id="category-select" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-brand-500 block p-2.5 font-medium cursor-pointer">
                            <!-- Categories populated by JS -->
                        </select>
                    </div>

                    <div class="p-6 space-y-8">
                        <!-- From Input -->
                        <div class="relative group">
                            <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">From</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600 group-focus-within:ring-2 group-focus-within:ring-brand-500 transition-all">
                                <input type="number" id="input-value" placeholder="0" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-0 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0">
                                <div class="bg-slate-50 dark:bg-slate-700 border-l border-slate-200 dark:border-slate-600 flex items-center px-2">
                                    <select id="from-unit" class="bg-transparent border-none text-sm font-medium focus:ring-0 text-slate-600 dark:text-slate-200 w-28 sm:w-40 md:w-56 cursor-pointer text-right pr-7">
                                        <!-- Units populated by JS -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Swap Button (Visual) -->
                        <div class="flex justify-center -my-4 relative z-10">
                            <button id="swap-btn" class="bg-brand-600 hover:bg-brand-700 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-transform hover:rotate-180 active:scale-95">
                                <i class="fa-solid fa-arrow-right-arrow-left text-sm"></i>
                            </button>
                        </div>

                        <!-- To Input (Read Only for Result) -->
                        <div class="relative group">
                            <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">To</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600 bg-slate-50 dark:bg-slate-900/50">
                                <input type="text" id="output-value" readonly placeholder="0" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-0 text-brand-600 dark:text-brand-400 cursor-default min-w-0">
                                <button onclick="window.copyResult()" class="flex items-center justify-center px-3 text-slate-400 hover:text-brand-500 transition-colors" title="Copy to Clipboard">
                                    <i id="copy-icon" class="fa-regular fa-copy"></i>
                                </button>
                                <div class="border-l border-slate-200 dark:border-slate-600 flex items-center px-2 bg-slate-50 dark:bg-slate-900/50">
                                    <select id="to-unit" class="bg-transparent border-none text-sm font-medium focus:ring-0 text-slate-600 dark:text-slate-200 w-28 sm:w-40 md:w-56 cursor-pointer text-right pr-7">
                                        <!-- Units populated by JS -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AdSense Slot 2 (Middle) -->
                <div class="ad-slot w-full h-20 bg-gray-200 dark:bg-slate-800 border-2 border-dashed border-gray-300 dark:border-slate-700 rounded-lg flex flex-col items-center justify-center text-gray-400 text-xs">
                    <span class="font-semibold">AdSense</span>
                    <span>Contextual Ad</span>
                </div>
            </div>

            <!-- History Section -->
            <div id="history-section" class="md:col-span-12 lg:col-span-5 h-full relative">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History
                        </h3>
                        <div id="history-actions" class="flex items-center gap-2">
                            <button id="print-history" type="button" class="text-xs text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-brand-400 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md transition-all flex items-center gap-1">
                                <i class="fa-solid fa-print"></i>
                            </button>
                            <button id="clear-history" type="button" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md transition-all disabled:opacity-50">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div id="history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <!-- Loading State -->
                        <div id="history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10">
                            <i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10">
                            <i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i>
                            <p id="history-empty-text" class="text-sm text-center">No conversions yet</p>
                        </div>

                        <!-- List Items (Injected by JS) -->
                        <div id="history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: PHYSICS CALCULATOR -->
        <div id="view-physics" class="view-section">
            <div class="max-w-2xl mx-auto space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2">
                            <i class="fa-solid fa-atom text-purple-500"></i> Physics
                        </h2>
                        <select id="physics-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-purple-500 block p-2.5 font-medium cursor-pointer w-48">
                            <!-- Formulas populated by JS -->
                        </select>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Input 1 -->
                        <div class="space-y-2">
                            <label id="phys-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600">
                                <input type="number" id="phys-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-purple-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0">
                            </div>
                        </div>

                        <!-- Input 2 -->
                        <div class="space-y-2">
                            <label id="phys-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600">
                                <input type="number" id="phys-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-purple-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0">
                            </div>
                        </div>

                        <!-- Calculate Button -->
                        <button onclick="calculatePhysics()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">
                            Calculate Result
                        </button>

                        <!-- Result -->
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="phys-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-purple-200 dark:ring-purple-900/50 bg-purple-50 dark:bg-purple-900/20">
                                <input type="text" id="phys-result" readonly class="flex-1 bg-transparent border-none p-4 text-2xl font-bold focus:ring-0 text-purple-600 dark:text-purple-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="mt-auto py-6 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
        <div class="max-w-4xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-xs text-slate-400">© 2025 UnitCV Pro. Securely powered by Firebase.</p>
            
            <!-- AdSense Slot 3 (Footer) -->
            <div class="ad-slot w-full md:w-1/3 h-16 bg-gray-200 dark:bg-slate-800 border-2 border-dashed border-gray-300 dark:border-slate-700 rounded flex items-center justify-center text-gray-400 text-[10px]">
                Ad Footer
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            deleteDoc, 
            doc, 
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unitcv-pro-dev';
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyCFrWdI9uhF9PYwfBLSLfhjttRV0nDI6GM",
                authDomain: "unitcv-pro.firebaseapp.com",
                projectId: "unitcv-pro",
                storageBucket: "unitcv-pro.firebasestorage.app",
                messagingSenderId: "130030967254",
                appId: "1:130030967254:web:1c38ded19fdf50f589ac77",
                measurementId: "G-23S89JVSM3"
            };
        }

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- VIEW MANAGEMENT ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });

            const targetId = 'view-' + viewName;
            const target = document.getElementById(targetId);
            
            if (target) {
                target.style.display = (viewName === 'home') ? 'grid' : 'block';
                if(viewName === 'converter') target.style.display = 'grid';
                
                setTimeout(() => target.classList.add('active'), 10);
            }

            const homeBtn = document.getElementById('home-btn');
            if (viewName === 'home') {
                homeBtn.classList.add('hidden');
                homeBtn.classList.remove('flex');
            } else {
                homeBtn.classList.remove('hidden');
                homeBtn.classList.add('flex');
            }
        };

        // --- PHYSICS CALCULATOR LOGIC ---
        const PHYSICS_DATA = {
            speed: { name: 'Speed (v = d/t)', l1: 'Distance (m)', l2: 'Time (s)', res: 'Speed (m/s)', calc: (a,b) => a/b },
            accel: { name: 'Acceleration (a = Δv/t)', l1: 'Change in Vel. (m/s)', l2: 'Time (s)', res: 'Accel (m/s²)', calc: (a,b) => a/b },
            force: { name: 'Force (F = ma)', l1: 'Mass (kg)', l2: 'Accel (m/s²)', res: 'Force (N)', calc: (a,b) => a*b },
            work: { name: 'Work (W = Fd)', l1: 'Force (N)', l2: 'Distance (m)', res: 'Work (J)', calc: (a,b) => a*b },
            power: { name: 'Power (P = W/t)', l1: 'Work (J)', l2: 'Time (s)', res: 'Power (W)', calc: (a,b) => a/b },
            ke: { name: 'Kinetic Energy', l1: 'Mass (kg)', l2: 'Velocity (m/s)', res: 'Energy (J)', calc: (a,b) => 0.5 * a * (b*b) }
        };

        function initPhysics() {
            const select = document.getElementById('physics-formula');
            Object.keys(PHYSICS_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = PHYSICS_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updatePhysicsUI);
            updatePhysicsUI();
        }

        function updatePhysicsUI() {
            const key = document.getElementById('physics-formula').value;
            const data = PHYSICS_DATA[key];
            document.getElementById('phys-label-1').textContent = data.l1;
            document.getElementById('phys-label-2').textContent = data.l2;
            document.getElementById('phys-label-result').textContent = data.res;
            document.getElementById('phys-result').value = '';
        }

        window.calculatePhysics = function() {
            const key = document.getElementById('physics-formula').value;
            const v1 = parseFloat(document.getElementById('phys-input-1').value);
            const v2 = parseFloat(document.getElementById('phys-input-2').value);
            
            if (isNaN(v1) || isNaN(v2)) {
                document.getElementById('phys-result').value = "Invalid Input";
                return;
            }
            
            const result = PHYSICS_DATA[key].calc(v1, v2);
            
            // Format nicely
            let formatted = result;
            if (Math.abs(result) < 0.001 || Math.abs(result) > 10000) {
                formatted = result.toExponential(3);
            } else {
                formatted = parseFloat(result.toFixed(4));
            }
            
            document.getElementById('phys-result').value = formatted;
        };

        // --- State Management ---
        let currentUser = null;
        let unsubscribeHistory = null;
        let lastConversion = null;
        let currentHistoryIds = [];

        // --- Unit Data Definitions ---
        const UNIT_DATA = {
            Length: {
                base: 'm',
                units: {
                    'm': { name: 'Meters', factor: 1 },
                    'km': { name: 'Kilometers', factor: 1000 },
                    'cm': { name: 'Centimeters', factor: 0.01 },
                    'mm': { name: 'Millimeters', factor: 0.001 },
                    'mi': { name: 'Miles', factor: 1609.34 },
                    'yd': { name: 'Yards', factor: 0.9144 },
                    'ft': { name: 'Feet', factor: 0.3048 },
                    'in': { name: 'Inches', factor: 0.0254 }
                }
            },
            Weight: {
                base: 'kg',
                units: {
                    'kg': { name: 'Kilograms', factor: 1 },
                    'g': { name: 'Grams', factor: 0.001 },
                    'mg': { name: 'Milligrams', factor: 0.000001 },
                    'lb': { name: 'Pounds', factor: 0.453592 },
                    'oz': { name: 'Ounces', factor: 0.0283495 },
                    'st': { name: 'Stone', factor: 6.35029 },
                    't': { name: 'Metric Ton', factor: 1000 }
                }
            },
            Temperature: {
                type: 'special',
                units: {
                    'C': { name: 'Celsius', toBase: v => v, fromBase: v => v },
                    'F': { name: 'Fahrenheit', toBase: v => (v - 32) * 5/9, fromBase: v => (v * 9/5) + 32 },
                    'K': { name: 'Kelvin', toBase: v => v - 273.15, fromBase: v => v + 273.15 }
                }
            },
            Volume: {
                base: 'l',
                units: {
                    'l': { name: 'Liters', factor: 1 },
                    'ml': { name: 'Milliliters', factor: 0.001 },
                    'gal': { name: 'Gallons (US)', factor: 3.78541 },
                    'qt': { name: 'Quarts (US)', factor: 0.946353 },
                    'pt': { name: 'Pints (US)', factor: 0.473176 },
                    'cup': { name: 'Cups', factor: 0.24 }
                }
            },
            Area: {
                base: 'sqm',
                units: {
                    'sqm': { name: 'Square Meters', factor: 1 },
                    'sqkm': { name: 'Square Kilometers', factor: 1000000 },
                    'sqft': { name: 'Square Feet', factor: 0.092903 },
                    'sqin': { name: 'Square Inches', factor: 0.00064516 },
                    'ha': { name: 'Hectares', factor: 10000 },
                    'ac': { name: 'Acres', factor: 4046.86 }
                }
            },
            Speed: {
                base: 'mps',
                units: {
                    'mps': { name: 'Meters/Sec', factor: 1 },
                    'kph': { name: 'Km/Hour', factor: 0.277778 },
                    'mph': { name: 'Miles/Hour', factor: 0.44704 },
                    'kn': { name: 'Knots', factor: 0.514444 }
                }
            },
            Time: {
                base: 's',
                units: {
                    's': { name: 'Seconds', factor: 1 },
                    'min': { name: 'Minutes', factor: 60 },
                    'h': { name: 'Hours', factor: 3600 },
                    'd': { name: 'Days', factor: 86400 },
                    'wk': { name: 'Weeks', factor: 604800 },
                    'mo': { name: 'Months (Avg)', factor: 2628000 },
                    'y': { name: 'Years', factor: 31536000 }
                }
            },
            Data: {
                base: 'b',
                units: {
                    'b': { name: 'Bytes', factor: 1 },
                    'kb': { name: 'Kilobytes', factor: 1024 },
                    'mb': { name: 'Megabytes', factor: 1048576 },
                    'gb': { name: 'Gigabytes', factor: 1073741824 },
                    'tb': { name: 'Terabytes', factor: 1099511627776 }
                }
            },
            Pressure: {
                base: 'pa',
                units: {
                    'pa': { name: 'Pascal', factor: 1 },
                    'bar': { name: 'Bar', factor: 100000 },
                    'psi': { name: 'PSI', factor: 6894.76 },
                    'atm': { name: 'Atmosphere', factor: 101325 }
                }
            },
            Energy: {
                base: 'j',
                units: {
                    'j': { name: 'Joules', factor: 1 },
                    'kj': { name: 'Kilojoules', factor: 1000 },
                    'cal': { name: 'Calories', factor: 4.184 },
                    'kcal': { name: 'Kilocalories', factor: 4184 },
                    'wh': { name: 'Watt-hour', factor: 3600 },
                    'kwh': { name: 'Kilowatt-hour', factor: 3600000 }
                }
            }
        };

        // --- DOM Elements ---
        const categorySelect = document.getElementById('category-select');
        const fromUnitSelect = document.getElementById('from-unit');
        const toUnitSelect = document.getElementById('to-unit');
        const inputVal = document.getElementById('input-value');
        const outputVal = document.getElementById('output-value');
        const swapBtn = document.getElementById('swap-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const authDot = document.getElementById('auth-dot');
        const authText = document.getElementById('auth-text');
        const historyList = document.getElementById('history-list');
        const historyEmpty = document.getElementById('history-empty');
        const historyEmptyText = document.getElementById('history-empty-text');
        const historyLoading = document.getElementById('history-loading');
        const clearHistoryBtn = document.getElementById('clear-history');
        const printHistoryBtn = document.getElementById('print-history');

        // --- UI Initialization ---
        function initUI() {
            // Populate Categories
            Object.keys(UNIT_DATA).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categorySelect.appendChild(opt);
            });

            // Dark Mode check
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // Event Listeners
            categorySelect.addEventListener('change', () => updateUnits(true));
            fromUnitSelect.addEventListener('change', calculate);
            toUnitSelect.addEventListener('change', calculate);
            inputVal.addEventListener('input', calculate);
            swapBtn.addEventListener('click', swapUnits);
            
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            });

            clearHistoryBtn.addEventListener('click', handleClearHistoryClick);
            
            printHistoryBtn.addEventListener('click', () => {
                window.focus();
                window.print();
            });

            // Initial Render
            updateUnits(true);
            
            // Initialize View (Show Home by default)
            switchView('home');
            
            // Initialize Physics
            initPhysics();
        }

        function updateUnits(reset = false) {
            const category = categorySelect.value;
            const units = UNIT_DATA[category].units;
            
            fromUnitSelect.innerHTML = '';
            toUnitSelect.innerHTML = '';

            Object.keys(units).forEach(key => {
                const createOpt = () => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = units[key].name;
                    return opt;
                };
                fromUnitSelect.appendChild(createOpt());
                toUnitSelect.appendChild(createOpt());
            });

            if (reset) {
                const keys = Object.keys(units);
                if (keys.length > 1) {
                    toUnitSelect.value = keys[1];
                }
                inputVal.value = '';
                outputVal.value = '';
            }
            calculate();
        }

        function swapUnits() {
            const temp = fromUnitSelect.value;
            fromUnitSelect.value = toUnitSelect.value;
            toUnitSelect.value = temp;
            calculate();
        }

        // --- Conversion Logic ---
        async function calculate() {
            const category = categorySelect.value;
            const fromUnit = fromUnitSelect.value;
            const toUnit = toUnitSelect.value;
            const val = parseFloat(inputVal.value);

            if (isNaN(val)) {
                outputVal.value = '';
                return;
            }

            let result;
            const catData = UNIT_DATA[category];

            if (catData.type === 'special') {
                const baseVal = catData.units[fromUnit].toBase(val);
                result = catData.units[toUnit].fromBase(baseVal);
            } else {
                const fromFactor = catData.units[fromUnit].factor;
                const toFactor = catData.units[toUnit].factor;
                result = val * (fromFactor / toFactor);
            }

            let formatted = result;
            if (Math.abs(result) < 0.000001 && result !== 0) {
                formatted = result.toExponential(4);
            } else if (Math.abs(result) > 1000000) {
                formatted = result.toExponential(4);
            } else {
                formatted = parseFloat(result.toPrecision(6)); 
            }

            outputVal.value = formatted;
            saveToHistory(val, fromUnit, formatted, toUnit, category);
        }

        let saveTimeout;
        function saveToHistory(inVal, inUnit, outVal, outUnit, cat) {
            if (!currentUser) return;

            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (inVal === '' || isNaN(inVal)) return;

                const path = `artifacts/${appId}/users/${currentUser.uid}/conversion_results`;
                
                try {
                    await addDoc(collection(db, path), {
                        inputVal: parseFloat(inVal),
                        inputUnit: inUnit,
                        outputVal: outVal,
                        outputUnit: outUnit,
                        category: cat,
                        timestamp: serverTimestamp()
                    });
                } catch (err) {
                    console.error("Error saving history:", err);
                }
            }, 1500);
        }

        // --- Authentication & Firestore ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed", error);
                authText.textContent = "Offline Mode";
                authDot.className = "w-2 h-2 bg-red-500 rounded-full mr-2";
                
                historyLoading.classList.add('hidden');
                historyEmpty.classList.remove('hidden');
                
                let errorMsg = "Connection Failed";
                if (error.code === 'auth/operation-not-allowed') {
                    errorMsg = "Enable Anonymous Auth<br><span class='text-[10px]'>Go to Firebase Console > Build > Authentication > Sign-in method</span>";
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMsg = "Domain Not Authorized<br><span class='text-[10px]'>Add this domain in Firebase Console > Authentication > Settings</span>";
                } else {
                    errorMsg = `Connection Failed<br><span class='text-[10px]'>${error.code || error.message}</span>`;
                }
                historyEmptyText.innerHTML = errorMsg;
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authText.textContent = `ID: ${user.uid.slice(0, 6)}...`;
                authDot.className = "w-2 h-2 bg-green-500 rounded-full mr-2";
                setupHistoryListener(user.uid);
            } else {
                currentUser = null;
                historyList.innerHTML = '';
                if (authText.textContent !== "Setup Required") {
                    authText.textContent = "Disconnected";
                    authDot.className = "w-2 h-2 bg-red-500 rounded-full mr-2";
                    historyLoading.classList.add('hidden');
                    historyEmpty.classList.remove('hidden');
                    historyEmptyText.textContent = "Not connected";
                }
            }
        });

        function setupHistoryListener(uid) {
            const path = `artifacts/${appId}/users/${uid}/conversion_results`;
            const q = collection(db, path);

            unsubscribeHistory = onSnapshot(q, (snapshot) => {
                const historyData = [];
                snapshot.forEach(doc => {
                    historyData.push({ id: doc.id, ...doc.data() });
                });

                currentHistoryIds = historyData.map(item => item.id);

                if (currentHistoryIds.length === 0) {
                    clearHistoryBtn.disabled = true;
                    clearHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    printHistoryBtn.disabled = true;
                    printHistoryBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    historyEmptyText.textContent = "No conversions yet";
                } else {
                    clearHistoryBtn.disabled = false;
                    clearHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    printHistoryBtn.disabled = false;
                    printHistoryBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }

                historyData.sort((a, b) => {
                    const tA = a.timestamp?.seconds || 0;
                    const tB = b.timestamp?.seconds || 0;
                    return tB - tA;
                });

                renderHistory(historyData);
                historyLoading.classList.add('hidden');
            }, (error) => {
                console.error("Snapshot error:", error);
                historyLoading.classList.add('hidden');
                historyList.innerHTML = `<div class="text-red-500 text-xs p-4">Sync Error. Check Permissions or Config.</div>`;
            });
        }

        function renderHistory(data) {
            historyList.innerHTML = '';
            if (data.length === 0) {
                historyEmpty.classList.remove('hidden');
                return;
            }
            historyEmpty.classList.add('hidden');

            data.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors group border border-transparent hover:border-slate-200 dark:hover:border-slate-600';
                
                const fromSymbol = UNIT_DATA[item.category]?.units[item.inputUnit]?.name || item.inputUnit;
                const toSymbol = UNIT_DATA[item.category]?.units[item.outputUnit]?.name || item.outputUnit;

                el.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span class="font-bold text-slate-700 dark:text-slate-200 truncate">${item.inputVal} <span class="text-xs font-normal text-slate-500">${item.inputUnit}</span></span>
                            <i class="fa-solid fa-arrow-right text-[10px] text-slate-400"></i>
                            <span class="font-bold text-brand-600 dark:text-brand-400 truncate">${item.outputVal} <span class="text-xs font-normal text-brand-500/70">${item.outputUnit}</span></span>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-0.5 flex items-center gap-2">
                            <span class="uppercase tracking-wider font-semibold text-slate-300 dark:text-slate-600 border border-slate-200 dark:border-slate-600 px-1 rounded">${item.category}</span>
                        </div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-red-500 p-2" onclick="window.deleteItem('${item.id}')">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;
                historyList.appendChild(el);
            });
        }

        window.deleteItem = async (docId) => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/conversion_results`, docId));
            } catch (e) {
                console.error("Delete failed", e);
            }
        };

        window.copyResult = function() {
            const output = document.getElementById('output-value');
            const icon = document.getElementById('copy-icon');
            if (output.value && output.value !== '') {
                const el = document.createElement('textarea');
                el.value = output.value;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                if(icon) {
                    icon.classList.remove('fa-regular', 'fa-copy');
                    icon.classList.add('fa-solid', 'fa-check', 'text-green-500');
                    setTimeout(() => {
                        icon.classList.remove('fa-solid', 'fa-check', 'text-green-500');
                        icon.classList.add('fa-regular', 'fa-copy');
                    }, 1000);
                }
            }
        };

        let clearConfirmTimer;
        async function handleClearHistoryClick() {
            if (!currentUser || currentHistoryIds.length === 0) return;
            const btn = document.getElementById('clear-history');
            if (btn.getAttribute('data-confirming') === 'true') {
                btn.innerText = "Clearing...";
                btn.disabled = true;
                try {
                    const promises = currentHistoryIds.map(id => 
                        deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/conversion_results`, id))
                    );
                    await Promise.all(promises);
                    btn.innerText = "Clear All";
                    btn.removeAttribute('data-confirming');
                    btn.disabled = false;
                } catch (e) {
                    console.error("Clear all failed", e);
                    btn.innerText = "Error";
                    setTimeout(() => {
                        btn.innerText = "Clear All";
                        btn.removeAttribute('data-confirming');
                        btn.disabled = false;
                    }, 2000);
                }
            } else {
                btn.innerText = "Confirm?";
                btn.setAttribute('data-confirming', 'true');
                btn.classList.add('bg-red-500', 'text-white');
                clearTimeout(clearConfirmTimer);
                clearConfirmTimer = setTimeout(() => {
                    btn.innerText = "Clear All";
                    btn.removeAttribute('data-confirming');
                    btn.classList.remove('bg-red-500', 'text-white');
                }, 3000);
            }
        }

        initUI();
        initAuth();

    </script>
</body>
</html>
