<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnitCV Pro - Universal Converter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Charts -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Input fixes */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }

        /* Dark Mode Select Fix */
        option { background-color: #ffffff; color: #1e293b; }
        .dark option { background-color: #1e293b; color: #f1f5f9; }

        /* View Utilities */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .view-section.active { display: grid; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #history-section, #history-section *, 
            #phys-history-section, #phys-history-section *,
            #fin-history-section, #fin-history-section *,
            #health-history-section, #health-history-section *,
            #math-history-section, #math-history-section *,
            #chem-history-section, #chem-history-section *,
            #eng-history-section, #eng-history-section * {
                visibility: visible;
            }
            #history-section, #phys-history-section, #fin-history-section, #health-history-section, #math-history-section, #chem-history-section, #eng-history-section {
                position: absolute; left: 0; top: 0; width: 100% !important; margin: 0 !important; padding: 0 !important;
                border: none !important; box-shadow: none !important; height: auto !important; max-height: none !important;
                background: white !important; color: black !important;
            }
            #history-container, #phys-history-container, #fin-history-container, #health-history-container, #math-history-container, #chem-history-container, #eng-history-container {
                height: auto !important; overflow: visible !important;
            }
            #history-actions, #phys-history-actions, #fin-history-actions, #health-history-actions, #math-history-actions, #chem-history-actions, #eng-history-actions,
            .fa-trash-can, button[id$="clear-history"] {
                display: none !important;
            }
            body { background: white; height: auto; overflow: visible; }
            
            /* Print Title */
            .history-print-title::before {
                content: "Calculation History Report";
                display: block; font-size: 24px; font-weight: bold; margin-bottom: 20px;
                text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="switchView('home')">
                <div class="bg-brand-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-layer-group"></i> 
                </div>
                <h1 class="text-xl font-bold tracking-tight text-slate-900 dark:text-white">UnitCV <span class="text-brand-500">Pro</span></h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="home-btn" onclick="switchView('home')" class="hidden text-sm font-medium text-slate-500 hover:text-brand-600 transition-colors items-center gap-2">
                    <i class="fa-solid fa-house"></i> <span class="hidden sm:inline">Home</span>
                </button>

                <div id="auth-status" class="hidden md:flex items-center text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full">
                    <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2 animate-pulse" id="auth-dot"></span>
                    <span id="auth-text">Connecting...</span>
                </div>
                <button id="theme-toggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-slate-600 dark:text-slate-300">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-4xl mx-auto px-4 py-6 w-full relative">
        
        <!-- VIEW 1: HOME DASHBOARD -->
        <div id="view-home" class="view-section active grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Converter -->
            <div onclick="switchView('converter')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-brand-500 dark:hover:border-brand-500 transition-all cursor-pointer group">
                <div class="bg-brand-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-brand-600 dark:text-brand-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-arrow-right-arrow-left text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Unit Converter</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Currency, Length, Weight, Volume, Temperature.</p>
            </div>

            <!-- Physics -->
            <div onclick="switchView('physics')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-purple-500 dark:hover:border-purple-500 transition-all cursor-pointer group">
                <div class="bg-purple-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-purple-600 dark:text-purple-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-atom text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Physics</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Speed, Force, Work, Energy, and Power.</p>
            </div>

            <!-- Finance -->
            <div onclick="switchView('finance')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-green-500 dark:hover:border-green-500 transition-all cursor-pointer group">
                <div class="bg-green-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-green-600 dark:text-green-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-sack-dollar text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Finance</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Loans, Mortgage, Interest, Salary & Savings.</p>
            </div>

            <!-- Health -->
            <div onclick="switchView('health')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-red-500 dark:hover:border-red-500 transition-all cursor-pointer group">
                <div class="bg-red-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-red-600 dark:text-red-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-heart-pulse text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Health</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">BMI, BMR, Body Fat and Calories.</p>
            </div>

            <!-- Math & Geometry -->
            <div onclick="switchView('math')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-blue-500 dark:hover:border-blue-500 transition-all cursor-pointer group">
                <div class="bg-blue-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-blue-600 dark:text-blue-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-shapes text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Math & Geometry</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Shapes, Areas, Volumes, Algebra & Trig.</p>
            </div>

            <!-- Chemistry -->
            <div onclick="switchView('chem')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-orange-500 dark:hover:border-orange-500 transition-all cursor-pointer group">
                <div class="bg-orange-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-orange-600 dark:text-orange-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-flask text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Chemistry</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">pH, Molar Mass, Dilution, Density.</p>
            </div>

            <!-- Engineering (NEW) -->
            <div onclick="switchView('eng')" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 hover:shadow-xl hover:border-cyan-500 dark:hover:border-cyan-500 transition-all cursor-pointer group">
                <div class="bg-cyan-50 dark:bg-slate-700 w-12 h-12 rounded-xl flex items-center justify-center text-cyan-600 dark:text-cyan-400 mb-4 group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-microchip text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Engineering</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400">Electronics, Circuits, PCB, Fluid Mechanics.</p>
            </div>
        </div>

        <!-- VIEW 2: UNIT CONVERTER -->
        <div id="view-converter" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg">Converter</h2>
                        <select id="category-select" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-brand-500 block p-2.5 font-medium cursor-pointer"></select>
                    </div>
                    <div class="p-6 space-y-8">
                        <div class="relative group">
                            <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">From</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600 group-focus-within:ring-2 group-focus-within:ring-brand-500 transition-all">
                                <input type="number" id="input-value" placeholder="0" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-0 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0">
                                <div class="bg-slate-50 dark:bg-slate-700 border-l border-slate-200 dark:border-slate-600 flex items-center px-2">
                                    <select id="from-unit" class="bg-transparent border-none text-sm font-medium focus:ring-0 text-slate-600 dark:text-slate-200 w-28 sm:w-40 md:w-56 cursor-pointer text-right pr-7"></select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center -my-4 relative z-10">
                            <button id="swap-btn" class="bg-brand-600 hover:bg-brand-700 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-transform hover:rotate-180 active:scale-95">
                                <i class="fa-solid fa-arrow-right-arrow-left text-sm"></i>
                            </button>
                        </div>
                        <div class="relative group">
                            <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">To</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600 bg-slate-50 dark:bg-slate-900/50">
                                <input type="text" id="output-value" readonly placeholder="0" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-0 text-brand-600 dark:text-brand-400 cursor-default min-w-0">
                                <button onclick="window.copyResult()" class="flex items-center justify-center px-3 text-slate-400 hover:text-brand-500 transition-colors" title="Copy to Clipboard">
                                    <i id="copy-icon" class="fa-regular fa-copy"></i>
                                </button>
                                <div class="border-l border-slate-200 dark:border-slate-600 flex items-center px-2 bg-slate-50 dark:bg-slate-900/50">
                                    <select id="to-unit" class="bg-transparent border-none text-sm font-medium focus:ring-0 text-slate-600 dark:text-slate-200 w-28 sm:w-40 md:w-56 cursor-pointer text-right pr-7"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- History (Reusable Component Structure) -->
            <div id="history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="history-actions" class="flex items-center gap-2">
                            <button id="print-history" class="text-xs text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-brand-400 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md transition-all"><i class="fa-solid fa-print"></i></button>
                            <button id="clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md transition-all disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="history-empty-text" class="text-sm text-center">No conversions yet</p></div>
                        <div id="history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: PHYSICS -->
        <div id="view-physics" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-atom text-purple-500"></i> Physics</h2>
                        <select id="physics-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-purple-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="space-y-2">
                            <label id="phys-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="phys-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-purple-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <div class="space-y-2">
                            <label id="phys-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="phys-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-purple-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <button onclick="calculatePhysics()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="phys-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-purple-200 dark:ring-purple-900/50 bg-purple-50 dark:bg-purple-900/20">
                                <input type="text" id="phys-result" readonly class="flex-1 bg-transparent border-none p-4 text-2xl font-bold focus:ring-0 text-purple-600 dark:text-purple-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Physics History -->
            <div id="phys-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="phys-history-actions" class="flex items-center gap-2">
                            <button id="phys-print-history" class="text-xs text-slate-500 hover:text-purple-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="phys-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="phys-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="phys-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="phys-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="phys-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="phys-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: FINANCE -->
        <div id="view-finance" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-sack-dollar text-green-500"></i> Finance</h2>
                        <select id="finance-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-green-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="space-y-2">
                            <label id="fin-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="fin-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-green-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <div class="space-y-2">
                            <label id="fin-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="fin-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-green-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <div id="fin-input-group-3" class="space-y-2">
                            <label id="fin-label-3" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 3</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="fin-input-3" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-green-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <div id="fin-input-group-4" class="space-y-2 hidden">
                            <label id="fin-label-4" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 4</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="fin-input-4" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-green-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div>
                        </div>
                        <button onclick="calculateFinance()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="fin-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-green-200 dark:ring-green-900/50 bg-green-50 dark:bg-green-900/20">
                                <input type="text" id="fin-result" readonly class="flex-1 bg-transparent border-none p-4 text-2xl font-bold focus:ring-0 text-green-600 dark:text-green-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                        <div id="finance-chart-container" class="w-full mt-6 space-y-6">
                            <div id="fin-chart-1" class="w-full h-64"></div>
                            <div id="fin-chart-2" class="w-full h-64"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Finance History -->
            <div id="fin-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="fin-history-actions" class="flex items-center gap-2">
                            <button id="fin-print-history" class="text-xs text-slate-500 hover:text-green-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="fin-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="fin-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="fin-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="fin-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="fin-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="fin-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: HEALTH -->
        <div id="view-health" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-heart-pulse text-red-500"></i> Health</h2>
                        <select id="health-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-red-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div id="health-gender-group">
                                <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Gender</label>
                                <select id="health-gender" class="w-full bg-slate-50 dark:bg-slate-700 border-none p-3 rounded-xl text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-red-500">
                                    <option value="male">Male</option><option value="female">Female</option>
                                </select>
                            </div>
                            <div id="health-activity-group" style="display:none;">
                                <label class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Activity</label>
                                <select id="health-activity" class="w-full bg-slate-50 dark:bg-slate-700 border-none p-3 rounded-xl text-slate-800 dark:text-slate-100 focus:ring-2 focus:ring-red-500">
                                    <option value="1.2">Sedentary</option><option value="1.375">Light</option><option value="1.55">Moderate</option><option value="1.725">Very Active</option><option value="1.9">Extra Active</option>
                                </select>
                            </div>
                        </div>
                        <div id="health-date-group" class="space-y-2 hidden">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Last Period Date</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="date" id="health-date" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-red-500 text-slate-800 dark:text-slate-100 min-w-0"></div>
                        </div>
                        <div id="health-inputs-container" class="space-y-4">
                            <!-- Dynamic inputs created by JS would be cleaner, but hardcoding 4 slots works -->
                            <div id="health-input-group-1" class="space-y-2"><label id="health-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="health-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-red-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="health-input-group-2" class="space-y-2"><label id="health-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="health-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-red-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="health-input-group-3" class="space-y-2 hidden"><label id="health-label-3" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 3</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="health-input-3" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-red-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="health-input-group-4" class="space-y-2 hidden"><label id="health-label-4" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 4</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="health-input-4" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-red-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                        </div>
                        <button onclick="calculateHealth()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="health-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-red-200 dark:ring-red-900/50 bg-red-50 dark:bg-red-900/20">
                                <input type="text" id="health-result" readonly class="flex-1 bg-transparent border-none p-4 text-xl font-bold focus:ring-0 text-red-600 dark:text-red-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                        <div id="health-chart-container" class="w-full mt-6 space-y-6">
                            <div id="health-chart-1" class="w-full h-64"></div>
                            <div id="health-chart-2" class="w-full h-64"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Health History -->
            <div id="health-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="health-history-actions" class="flex items-center gap-2">
                            <button id="health-print-history" class="text-xs text-slate-500 hover:text-red-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="health-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="health-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="health-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="health-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="health-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="health-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 6: MATH & GEOMETRY (NEW) -->
        <div id="view-math" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-shapes text-blue-500"></i> Math</h2>
                        <select id="math-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-blue-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div id="math-inputs-container" class="space-y-4">
                            <div id="math-input-group-1" class="space-y-2"><label id="math-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="math-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-blue-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="math-input-group-2" class="space-y-2"><label id="math-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="math-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-blue-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="math-input-group-3" class="space-y-2 hidden"><label id="math-label-3" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 3</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="math-input-3" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-blue-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                        </div>
                        <button onclick="calculateMath()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="math-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-blue-200 dark:ring-blue-900/50 bg-blue-50 dark:bg-blue-900/20">
                                <input type="text" id="math-result" readonly class="flex-1 bg-transparent border-none p-4 text-xl font-bold focus:ring-0 text-blue-600 dark:text-blue-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                        <div id="math-chart-container" class="w-full mt-6 space-y-6 flex justify-center">
                            <div id="math-chart-1" class="w-full h-64"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Math History -->
            <div id="math-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="math-history-actions" class="flex items-center gap-2">
                            <button id="math-print-history" class="text-xs text-slate-500 hover:text-blue-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="math-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="math-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="math-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="math-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="math-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="math-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 7: CHEMISTRY / MATERIALS (NEW) -->
        <div id="view-chem" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-flask text-orange-500"></i> Chemistry</h2>
                        <select id="chem-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-orange-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div id="chem-inputs-container" class="space-y-4">
                            <!-- Text Input for Formulas (MW) -->
                            <div id="chem-input-text-group" class="space-y-2 hidden">
                                <label id="chem-label-text" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Chemical Formula</label>
                                <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600">
                                    <input type="text" id="chem-input-text" placeholder="e.g. C6H12O6" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-orange-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0 uppercase">
                                </div>
                            </div>
                            <!-- Number Inputs -->
                            <div id="chem-input-group-1" class="space-y-2"><label id="chem-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="chem-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-orange-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="chem-input-group-2" class="space-y-2"><label id="chem-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="chem-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-orange-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="chem-input-group-3" class="space-y-2 hidden"><label id="chem-label-3" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 3</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="chem-input-3" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-orange-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                        </div>
                        <button onclick="calculateChem()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="chem-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-orange-200 dark:ring-orange-900/50 bg-orange-50 dark:bg-orange-900/20">
                                <input type="text" id="chem-result" readonly class="flex-1 bg-transparent border-none p-4 text-xl font-bold focus:ring-0 text-orange-600 dark:text-orange-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                        <div id="chem-chart-container" class="w-full mt-6 space-y-6 flex justify-center">
                            <div id="chem-chart-1" class="w-full h-64"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chem History -->
            <div id="chem-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="chem-history-actions" class="flex items-center gap-2">
                            <button id="chem-print-history" class="text-xs text-slate-500 hover:text-orange-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="chem-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="chem-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="chem-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="chem-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="chem-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="chem-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 8: ENGINEERING (NEW) -->
        <div id="view-eng" class="view-section gap-6 md:grid-cols-12">
            <div class="md:col-span-12 lg:col-span-7 space-y-6">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-semibold text-lg flex items-center gap-2"><i class="fa-solid fa-microchip text-cyan-500"></i> Engineering</h2>
                        <select id="eng-formula" class="bg-slate-50 dark:bg-slate-700 border-none text-sm rounded-lg focus:ring-2 focus:ring-cyan-500 block p-2.5 font-medium cursor-pointer w-48"></select>
                    </div>
                    <div class="p-6 space-y-6">
                        <div id="eng-inputs-container" class="space-y-4">
                            <div id="eng-input-group-1" class="space-y-2"><label id="eng-label-1" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 1</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="eng-input-1" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-cyan-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="eng-input-group-2" class="space-y-2"><label id="eng-label-2" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 2</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="eng-input-2" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-cyan-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="eng-input-group-3" class="space-y-2 hidden"><label id="eng-label-3" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 3</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="eng-input-3" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-cyan-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                            <div id="eng-input-group-4" class="space-y-2 hidden"><label id="eng-label-4" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Input 4</label><div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-600"><input type="number" id="eng-input-4" class="flex-1 bg-transparent border-none p-3 text-xl font-bold focus:ring-2 focus:ring-cyan-500 text-slate-800 dark:text-slate-100 placeholder-slate-300 min-w-0"></div></div>
                        </div>
                        <button onclick="calculateEng()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95">Calculate Result</button>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <label id="eng-label-result" class="block mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider">Result</label>
                            <div class="flex shadow-sm rounded-xl overflow-hidden ring-1 ring-cyan-200 dark:ring-cyan-900/50 bg-cyan-50 dark:bg-cyan-900/20">
                                <input type="text" id="eng-result" readonly class="flex-1 bg-transparent border-none p-4 text-xl font-bold focus:ring-0 text-cyan-600 dark:text-cyan-400 cursor-default min-w-0" placeholder="-">
                            </div>
                        </div>
                        <div id="eng-chart-container" class="w-full mt-6 space-y-6 flex justify-center">
                            <div id="eng-chart-1" class="w-full h-64"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Eng History -->
            <div id="eng-history-section" class="md:col-span-12 lg:col-span-5 h-full relative history-print-title">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 h-full flex flex-col max-h-[600px] lg:max-h-none">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50">
                        <h3 class="font-semibold flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-slate-400"></i> History</h3>
                        <div id="eng-history-actions" class="flex items-center gap-2">
                            <button id="eng-print-history" class="text-xs text-slate-500 hover:text-cyan-600 hover:bg-slate-100 dark:hover:bg-slate-700 font-medium px-3 py-1.5 rounded-md"><i class="fa-solid fa-print"></i></button>
                            <button id="eng-clear-history" class="text-xs text-red-500 hover:text-white hover:bg-red-500 border border-red-200 dark:border-red-900/50 font-medium px-3 py-1.5 rounded-md disabled:opacity-50">Clear All</button>
                        </div>
                    </div>
                    <div id="eng-history-container" class="flex-1 overflow-y-auto p-4 space-y-3 relative">
                        <div id="eng-history-loading" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10"><i class="fa-solid fa-circle-notch fa-spin text-brand-500 text-2xl"></i></div>
                        <div id="eng-history-empty" class="hidden h-full flex flex-col items-center justify-center text-slate-400 py-10"><i class="fa-regular fa-clipboard text-4xl mb-3 opacity-50"></i><p id="eng-history-empty-text" class="text-sm text-center">No calculations yet</p></div>
                        <div id="eng-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-auto py-6 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
        <div class="max-w-4xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <p class="text-xs text-slate-400"> 2025 UnitCV Pro. Securely powered by Firebase.</p>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unitcv-pro-dev';
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyCFrWdI9uhF9PYwfBLSLfhjttRV0nDI6GM",
                authDomain: "unitcv-pro.firebaseapp.com",
                projectId: "unitcv-pro",
                storageBucket: "unitcv-pro.firebasestorage.app",
                messagingSenderId: "130030967254",
                appId: "1:130030967254:web:1c38ded19fdf50f589ac77",
                measurementId: "G-23S89JVSM3"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- VIEW MANAGEMENT ---
        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });

            const targetId = 'view-' + viewName;
            const target = document.getElementById(targetId);
            
            if (target) {
                target.style.display = (viewName === 'home') ? 'grid' : 'grid'; 
                setTimeout(() => {
                    target.classList.add('active');
                    if(viewName === 'finance' && window.lastFinanceChartData) drawFinanceCharts(window.lastFinanceChartData);
                    if(viewName === 'health' && window.lastHealthChartData) drawHealthCharts(window.lastHealthChartData);
                    if(viewName === 'math') {
                        if(window.lastMathChartData) drawMathCharts(window.lastMathChartData);
                        else if(window.lastMathSVG) drawMathSVG(window.lastMathSVG);
                    }
                    if(viewName === 'chem') {
                        if(window.lastChemChartData) drawChemCharts(window.lastChemChartData);
                        else if(window.lastChemSVG) drawChemSVG(window.lastChemSVG);
                    }
                    if(viewName === 'eng') {
                        if(window.lastEngChartData) drawEngCharts(window.lastEngChartData);
                        else if(window.lastEngSVG) drawEngSVG(window.lastEngSVG);
                    }
                }, 10);
            }

            const homeBtn = document.getElementById('home-btn');
            if (viewName === 'home') {
                homeBtn.classList.add('hidden');
                homeBtn.classList.remove('flex');
            } else {
                homeBtn.classList.remove('hidden');
                homeBtn.classList.add('flex');
            }
        };

        // --- ENGINEERING DATA (NEW) ---
        const ENG_DATA = {
            ohm: {
                name: 'AC Impedance (RLC)', l1: 'R ()', l2: 'L (H)', l3: 'C (F)', l4: 'Freq (Hz)', inputs: 4,
                calc: (v) => {
                    const [R, L, C, f] = v;
                    const XL = 2 * Math.PI * f * L;
                    const XC = 1 / (2 * Math.PI * f * C);
                    const Z = Math.sqrt(R*R + (XL-XC)*(XL-XC));
                    return Z;
                },
                format: (v) => `Z = ${v.toFixed(2)} `,
                draw: (v) => {
                    const [R, L, C, f] = v;
                    const XL = 2 * Math.PI * f * L;
                    const XC = 1 / (2 * Math.PI * f * C);
                    const netX = XL - XC;
                    // Draw Phasor
                    // Scale to box 200x200 centered 100,100
                    const maxVal = Math.max(R, Math.abs(netX)) * 1.2 || 1;
                    const scale = 80 / maxVal;
                    const x2 = 100 + R*scale;
                    const y2 = 100 - netX*scale; // SVG y is down
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#64748b" /></marker></defs><line x1="20" y1="100" x2="180" y2="100" stroke="#cbd5e1" stroke-width="1" marker-end="url(#arrow)"/><line x1="100" y1="180" x2="100" y2="20" stroke="#cbd5e1" stroke-width="1" marker-end="url(#arrow)"/><line x1="100" y1="100" x2="${x2}" y2="${y2}" stroke="#3b82f6" stroke-width="2"/><text x="180" y="115" font-size="10" fill="#64748b">R</text><text x="110" y="20" font-size="10" fill="#64748b">X</text><text x="10" y="10" font-size="10" fill="#3b82f6">Z=${Math.sqrt(R*R+netX*netX).toFixed(1)}</text></svg>`;
                }
            },
            rc: {
                name: 'RC Time Constant', l1: 'R ()', l2: 'C (F)', l3: 'Volts (V)', inputs: 3,
                calc: (v) => v[0] * v[1],
                format: (v) => ` = ${v.toExponential(2)} s`,
                getChartData: (v) => {
                    const [R, C, V] = v;
                    const tau = R*C;
                    const rows = [['Time (s)', 'Volts']];
                    for(let t=0; t<=5*tau; t+=tau/5) {
                        rows.push([t, V * (1 - Math.exp(-t/tau))]);
                    }
                    return { type: 'Line', data: rows, title: 'Capacitor Charge Curve' };
                }
            },
            xl: {
                name: 'Inductor Reactance', l1: 'Freq (Hz)', l2: 'L (H)', inputs: 2,
                calc: (v) => 2 * Math.PI * v[0] * v[1],
                format: (v) => `XL = ${v.toFixed(2)} `,
                draw: (v) => `<div class="flex items-center justify-center h-full"><svg viewBox="0 0 100 50" class="w-32"><path d="M10 25 q10 -20 20 0 t20 0 t20 0 t20 0" fill="none" stroke="#3b82f6" stroke-width="3"/></svg></div>`
            },
            bjt: {
                name: 'BJT Bias (Fixed)', l1: 'Vcc (V)', l2: 'Rb ()', l3: 'Rc ()', l4: 'Beta', inputs: 4,
                calc: (v) => {
                    const [Vcc, Rb, Rc, beta] = v;
                    const Ib = (Vcc - 0.7) / Rb;
                    const Ic = beta * Ib;
                    const Vce = Vcc - (Ic * Rc);
                    return Vce; // Return Vce, display string in format
                },
                format: (res) => {
                    // We need input vals here, but this design passes raw result. 
                    // Let's rely on global state or re-calc for display? 
                    // For simplicity, result is Vce. We can adjust calc to return object?
                    // The standard handler expects number/string.
                    return `Vce  ${res.toFixed(2)} V`;
                },
                draw: (v) => `<svg viewBox="0 0 200 200" class="w-full h-full"><rect x="60" y="20" width="80" height="160" fill="none" stroke="#e2e8f0"/><circle cx="100" cy="100" r="30" fill="none" stroke="#3b82f6"/><line x1="70" y1="100" x2="100" y2="100" stroke="#3b82f6"/><line x1="100" y1="100" x2="120" y2="70" stroke="#3b82f6"/><line x1="100" y1="100" x2="120" y2="130" stroke="#3b82f6"/><text x="140" y="100" font-size="12" fill="#64748b">NPN</text></svg>`
            },
            led: {
                name: 'LED Resistor', l1: 'Source V', l2: 'LED Vf', l3: 'LED If (A)', inputs: 3,
                calc: (v) => (v[0] - v[1]) / v[2],
                format: (v) => `R = ${v.toFixed(1)} `,
                draw: (v) => `<svg viewBox="0 0 200 100" class="w-full h-full"><rect x="10" y="40" width="10" height="20" fill="#3b82f6"/><line x1="20" y1="50" x2="60" y2="50" stroke="#3b82f6"/><path d="M60 45 l10 5 l-10 5 z" fill="#ef4444"/><line x1="70" y1="50" x2="100" y2="50" stroke="#3b82f6"/><rect x="100" y="45" width="40" height="10" fill="none" stroke="#3b82f6"/><line x1="140" y1="50" x2="190" y2="50" stroke="#3b82f6"/><text x="120" y="35" font-size="10" text-anchor="middle" fill="#64748b">Resistor</text></svg>`
            },
            pcb: {
                name: 'PCB Trace Width (IPC-2221)', l1: 'Current (A)', l2: 'Temp Rise (C)', l3: 'Thickness (oz)', inputs: 3,
                calc: (v) => {
                    const [I, dT, th] = v;
                    // k=0.048 for external layers
                    const area = Math.pow(I / (0.048 * Math.pow(dT, 0.44)), 1/0.725); // mils^2
                    const thMils = th * 1.37; // 1 oz approx 1.37 mil
                    const widthMils = area / thMils;
                    return widthMils * 0.0254; // Convert mil to mm
                },
                format: (v) => `Width: ${v.toFixed(3)} mm`
            },
            awg: {
                name: 'AWG to mm', l1: 'AWG Number', inputs: 1,
                calc: (v) => 0.127 * Math.pow(92, (36 - v[0])/39),
                format: (v) => `Dia: ${v.toFixed(3)} mm`
            },
            batt: {
                name: 'Battery Life', l1: 'Capacity (mAh)', l2: 'Load (mA)', inputs: 2,
                calc: (v) => (v[0] / v[1]) * 0.7, // 0.7 safety factor
                format: (v) => `~${v.toFixed(1)} Hours`
            },
            reynolds: {
                name: 'Reynolds Number', l1: 'Density (kg/m)', l2: 'Velocity (m/s)', l3: 'Dia (m)', l4: 'Visc (Pas)', inputs: 4,
                calc: (v) => (v[0] * v[1] * v[2]) / v[3],
                format: (v) => `Re = ${v.toExponential(2)}`,
                getChartData: (v, txt, res) => {
                    const val = (v[0] * v[1] * v[2]) / v[3];
                    // Cap gauge for visualization
                    let displayVal = val;
                    if(val > 5000) displayVal = 5000;
                    return { type: 'Gauge', data: [['Label', 'Value'], ['Re', displayVal]], title: 'Flow Type', max: 5000, redFrom: 4000, redTo: 5000, yellowFrom: 2300, yellowTo: 4000, greenFrom: 0, greenTo: 2300 };
                }
            },
            flow: {
                name: 'Pipe Flow Rate', l1: 'Diameter (m)', l2: 'Velocity (m/s)', inputs: 2,
                calc: (v) => Math.PI * Math.pow(v[0]/2, 2) * v[1],
                format: (v) => `${v.toFixed(4)} m/s`
            },
            pressure: {
                name: 'Pressure Drop (Laminar)', l1: 'Visc (Pas)', l2: 'Length (m)', l3: 'Flow (m/s)', l4: 'Radius (m)', inputs: 4,
                calc: (v) => (8 * v[0] * v[1] * v[2]) / (Math.PI * Math.pow(v[3], 4)),
                format: (v) => `P = ${v.toExponential(2)} Pa`
            }
        };

        // --- CHEMISTRY DATA & LOGIC ---
        const ATOMIC_MASSES = {
            H:1.008, He:4.0026, Li:6.94, Be:9.0122, B:10.81, C:12.011, N:14.007, O:15.999, F:18.998, Ne:20.180, 
            Na:22.990, Mg:24.305, Al:26.982, Si:28.085, P:30.974, S:32.06, Cl:35.45, K:39.098, Ar:39.948, Ca:40.078, 
            Sc:44.956, Ti:47.867, V:50.942, Cr:51.996, Mn:54.938, Fe:55.845, Co:58.933, Ni:58.693, Cu:63.546, Zn:65.38, 
            Ga:69.723, Ge:72.630, As:74.922, Se:78.971, Br:79.904, Kr:83.798, Rb:85.468, Sr:87.62, Y:88.906, Zr:91.224, 
            Nb:92.906, Mo:95.95, Tc:98, Ru:101.07, Rh:102.91, Pd:106.42, Ag:107.87, Cd:112.41, In:114.82, Sn:118.71, 
            Sb:121.76, Te:127.60, I:126.90, Xe:131.29, Cs:132.91, Ba:137.33, La:138.91, Ce:140.12, Pr:140.91, Nd:144.24, 
            Pm:145, Sm:150.36, Eu:151.96, Gd:157.25, Tb:158.93, Dy:162.50, Ho:164.93, Er:167.26, Tm:168.93, Yb:173.05, 
            Lu:174.97, Hf:178.49, Ta:180.95, W:183.84, Re:186.21, Os:190.23, Ir:192.22, Pt:195.08, Au:196.97, Hg:200.59, 
            Tl:204.38, Pb:207.2, Bi:208.98, Po:209, At:210, Rn:222, Fr:223, Ra:226, Ac:227, Th:232.04, Pa:231.04, U:238.03
        };

        function parseFormula(formula) {
            const regex = /([A-Z][a-z]*)(\d*)/g;
            let match;
            const composition = {};
            let totalMass = 0;
            while ((match = regex.exec(formula)) !== null) {
                const elem = match[1];
                const count = parseInt(match[2] || 1);
                const mass = ATOMIC_MASSES[elem];
                if(mass) {
                    composition[elem] = (composition[elem] || 0) + count;
                    totalMass += mass * count;
                }
            }
            return { totalMass, composition };
        }

        const CHEM_DATA = {
            ph: {
                name: 'pH  [H] & [OH]', l1: 'pH Value', inputs: 1,
                calc: (v) => { 
                    const h = Math.pow(10, -v[0]); 
                    const oh = 1.0e-14 / h; 
                    return `[H]: ${h.toExponential(2)} M, [OH]: ${oh.toExponential(2)} M`;
                },
                format: (v) => v,
                getChartData: (v) => {
                    const val = v[0];
                    return { type: 'Gauge', data: [['Label', 'Value'], ['pH', val]], title: 'pH Level', max: 14, redFrom: 0, redTo: 6, yellowFrom: 6, yellowTo: 8, greenFrom: 8, greenTo: 14 };
                }
            },
            dilution: {
                name: 'Dilution (Calc V2)', l1: 'C1 (Initial)', l2: 'V1 (Initial)', l3: 'C2 (Final)', inputs: 3,
                calc: (v) => { return (v[0] * v[1]) / v[2]; },
                format: (v) => `V2 = ${v.toFixed(2)} units`,
                draw: (v) => {
                    const [c1, v1, c2] = v;
                    const v2 = (c1 * v1) / c2;
                    // Visual scale factor
                    const maxV = Math.max(v1, v2);
                    const h1 = (v1/maxV)*100;
                    const h2 = (v2/maxV)*100;
                    const op1 = Math.min(1, c1/10 + 0.2); // Visual opacity based on conc
                    const op2 = Math.min(1, c2/10 + 0.2);
                    return `<svg viewBox="0 0 200 150" class="w-full h-full"><rect x="30" y="${120-h1}" width="40" height="${h1}" fill="#3b82f6" fill-opacity="${op1}" stroke="#1e293b" stroke-width="2"/><text x="50" y="140" text-anchor="middle" font-size="10">Initial (V1=${v1})</text><text x="100" y="75" text-anchor="middle" font-size="20"></text><rect x="130" y="${120-h2}" width="40" height="${h2}" fill="#3b82f6" fill-opacity="${op2}" stroke="#1e293b" stroke-width="2"/><text x="150" y="140" text-anchor="middle" font-size="10">Final (V2=${v2.toFixed(1)})</text></svg>`;
                }
            },
            mw: {
                name: 'Molecular Weight', l1: '', inputs: 0, showText: true,
                calc: (v, txt) => {
                    const res = parseFormula(txt);
                    return res.totalMass === 0 ? "Invalid Formula" : `${res.totalMass.toFixed(3)} g/mol`;
                },
                format: (v) => v,
                getChartData: (v, txt) => {
                    const res = parseFormula(txt);
                    if(res.totalMass === 0) return null;
                    const rows = [['Element', 'Mass %']];
                    Object.keys(res.composition).forEach(el => {
                        const mass = ATOMIC_MASSES[el] * res.composition[el];
                        rows.push([el, mass]);
                    });
                    return { type: 'Pie', data: rows, title: 'Mass Composition' };
                }
            },
            stoich: {
                name: 'Mole Ratio (Reactant -> Product)', l1: 'Moles Reactant', l2: 'Coeff Reactant', l3: 'Coeff Product', inputs: 3,
                calc: (v) => (v[0] / v[1]) * v[2],
                format: (v) => `${v.toFixed(3)} moles Product`,
                draw: (v) => `<div class="flex items-center justify-center h-full text-sm text-slate-500">Ratio: ${v[1]} : ${v[2]}</div>`
            },
            gibbs: {
                name: 'Gibbs Free Energy (G = H - TS)', l1: 'H (kJ)', l2: 'S (J/K)', l3: 'Temp (K)', inputs: 3,
                calc: (v) => v[0] - (v[2] * (v[1]/1000)), // Convert S to kJ
                format: (v) => `G = ${v.toFixed(2)} kJ`,
                getChartData: (v) => {
                    const [h, s, t] = v;
                    const rows = [['Temp (K)', 'G (kJ)']];
                    for(let temp=Math.max(0, t-100); temp<=t+100; temp+=20) {
                        rows.push([temp, h - (temp * s/1000)]);
                    }
                    return { type: 'Line', data: rows, title: 'Spontaneity vs Temp' };
                }
            },
            density: {
                name: 'Density ( = m/v)', l1: 'Mass (g)', l2: 'Volume (ml)', inputs: 2,
                calc: (v) => v[0] / v[1],
                format: (v) => `${v.toFixed(3)} g/ml`,
                draw: (v) => {
                    const d = v[0]/v[1];
                    // Visual representation: Particles packed in a box
                    const count = Math.min(50, Math.floor(d * 10)); 
                    let dots = "";
                    for(let i=0; i<count; i++) {
                        const x = Math.random()*80 + 10;
                        const y = Math.random()*80 + 10;
                        dots += `<circle cx="${x}" cy="${y}" r="2" fill="#475569"/>`;
                    }
                    return `<svg viewBox="0 0 100 100" class="w-full h-full" style="max-width:150px; margin:0 auto;"><rect x="5" y="5" width="90" height="90" fill="none" stroke="#3b82f6" stroke-width="2"/>${dots}<text x="50" y="115" text-anchor="middle" font-size="10">Density Visual</text></svg>`;
                }
            },
            heat: {
                name: 'Specific Heat (q = mcT)', l1: 'Mass (g)', l2: 'Sp. Heat (J/gC)', l3: ' Temp (C)', inputs: 3,
                calc: (v) => v[0] * v[1] * v[2],
                format: (v) => `Heat (q) = ${v.toFixed(2)} J`,
                draw: (v) => {
                    const color = v[2] > 0 ? "#ef4444" : "#3b82f6"; // Red for heating, blue for cooling
                    return `<svg viewBox="0 0 200 60" class="w-full h-full"><rect x="10" y="20" width="180" height="20" rx="10" fill="#e2e8f0"/><rect x="10" y="20" width="180" height="20" rx="10" fill="${color}" fill-opacity="0.5"><animate attributeName="width" from="0" to="180" dur="1s" fill="freeze"/></rect><text x="100" y="55" text-anchor="middle" font-size="12" fill="#64748b">Energy Transfer</text></svg>`;
                }
            }
        };

        // --- MATH CALCULATOR LOGIC (Unchanged) ---
        const MATH_DATA = {
            circle: {
                name: 'Circle Properties', l1: 'Radius (r)', inputs: 1,
                calc: (v) => {
                    const area = Math.PI * v[0] * v[0];
                    const circ = 2 * Math.PI * v[0];
                    return `A: ${area.toFixed(2)}, C: ${circ.toFixed(2)}`;
                },
                format: (v) => v,
                draw: (v, container) => {
                    const r = 80; // Fixed visual radius
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><circle cx="100" cy="100" r="${r}" fill="none" stroke="#3b82f6" stroke-width="2"/><line x1="100" y1="100" x2="${100+r}" y2="100" stroke="#ef4444" stroke-width="2"/><text x="130" y="90" fill="#64748b" font-size="12">r=${v[0]}</text><text x="100" y="195" text-anchor="middle" fill="#64748b" font-size="12">Area: ${(Math.PI*v[0]*v[0]).toFixed(2)}</text></svg>`;
                }
            },
            triangle: {
                name: 'Triangle Area (Heron)', l1: 'Side A', l2: 'Side B', l3: 'Side C', inputs: 3,
                calc: (v) => {
                    const [a, b, c] = v;
                    const s = (a + b + c) / 2;
                    if(s <= a || s <= b || s <= c) return "Impossible Triangle";
                    const area = Math.sqrt(s * (s - a) * (s - b) * (s - c));
                    return area;
                },
                format: (v) => typeof v === 'string' ? v : `${v.toFixed(2)} units`,
                draw: (v, container) => {
                    const [a, b, c] = v;
                    if((a+b<=c) || (a+c<=b) || (b+c<=a)) return `<div class="text-red-500 text-center">Invalid Triangle</div>`;
                    const x = (b*b + c*c - a*a) / (2*c);
                    const y = Math.sqrt(Math.abs(b*b - x*x));
                    const maxX = Math.max(c, x); const minX = Math.min(0, x);
                    const width = maxX - minX; const height = y;
                    const scale = 160 / Math.max(width, height);
                    const offX = (200 - width*scale)/2 - minX*scale; const offY = (200 - height*scale)/2;
                    const Ax = offX, Ay = 200-offY; const Bx = offX + c*scale, By = 200-offY; const Cx = offX + x*scale, Cy = 200-(offY + y*scale);
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><polygon points="${Ax},${Ay} ${Bx},${By} ${Cx},${Cy}" fill="none" stroke="#3b82f6" stroke-width="2"/><text x="${(Ax+Bx)/2}" y="${Ay+15}" text-anchor="middle" fill="#64748b" font-size="10">c=${c}</text><text x="${(Ax+Cx)/2-10}" y="${(Ay+Cy)/2}" text-anchor="end" fill="#64748b" font-size="10">b=${b}</text><text x="${(Bx+Cx)/2+10}" y="${(By+Cy)/2}" text-anchor="start" fill="#64748b" font-size="10">a=${a}</text></svg>`;
                }
            },
            rect: {
                name: 'Rectangle', l1: 'Length', l2: 'Width', inputs: 2,
                calc: (v) => { return `Area: ${v[0]*v[1]}, Peri: ${2*(v[0]+v[1])}`; },
                format: (v) => v,
                draw: (v, container) => {
                    const l = v[0], w = v[1];
                    const ratio = l/w;
                    let dl, dw; if(ratio > 1) { dl = 160; dw = 160/ratio; } else { dw = 160; dl = 160*ratio; }
                    const x = (200-dl)/2; const y = (200-dw)/2;
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><rect x="${x}" y="${y}" width="${dl}" height="${dw}" fill="none" stroke="#3b82f6" stroke-width="2"/><text x="${100}" y="${y-5}" text-anchor="middle" fill="#64748b" font-size="12">L=${l}</text><text x="${x+dl+5}" y="${100}" alignment-baseline="middle" fill="#64748b" font-size="12">W=${w}</text></svg>`;
                }
            },
            cylinder: {
                name: 'Cylinder Volume', l1: 'Radius', l2: 'Height', inputs: 2,
                calc: (v) => Math.PI * v[0] * v[0] * v[1],
                format: (v) => `${v.toFixed(2)} units`,
                draw: (v, container) => {
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><ellipse cx="100" cy="50" rx="50" ry="15" fill="none" stroke="#3b82f6" stroke-width="2"/><line x1="50" y1="50" x2="50" y2="150" stroke="#3b82f6" stroke-width="2"/><line x1="150" y1="50" x2="150" y2="150" stroke="#3b82f6" stroke-width="2"/><path d="M50 150 A50 15 0 0 0 150 150" fill="none" stroke="#3b82f6" stroke-width="2"/><path d="M50 150 A50 15 0 0 1 150 150" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4"/><text x="160" y="100" fill="#64748b" font-size="12">h=${v[1]}</text><line x1="100" y1="50" x2="150" y2="50" stroke="#ef4444" stroke-width="1"/><text x="110" y="40" fill="#64748b" font-size="10">r=${v[0]}</text></svg>`;
                }
            },
            sphere: {
                name: 'Sphere Properties', l1: 'Radius', inputs: 1,
                calc: (v) => {
                    const vol = (4/3) * Math.PI * Math.pow(v[0], 3);
                    const area = 4 * Math.PI * v[0] * v[0];
                    return `Vol: ${vol.toFixed(2)}, Surf: ${area.toFixed(2)}`;
                },
                format: (v) => v,
                draw: (v, container) => {
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><circle cx="100" cy="100" r="70" fill="none" stroke="#3b82f6" stroke-width="2"/><ellipse cx="100" cy="100" rx="70" ry="20" fill="none" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4"/><line x1="100" y1="100" x2="170" y2="100" stroke="#ef4444" stroke-width="2"/><text x="120" y="90" fill="#64748b" font-size="12">r=${v[0]}</text></svg>`;
                }
            },
            quadratic: {
                name: 'Quadratic Solver (ax+bx+c)', l1: 'a', l2: 'b', l3: 'c', inputs: 3,
                calc: (v) => {
                    const [a, b, c] = v;
                    if (a === 0) return "Not Quadratic";
                    const delta = b*b - 4*a*c;
                    if (delta < 0) return "No Real Roots";
                    if (delta === 0) return `x = ${-b/(2*a)}`;
                    const x1 = (-b + Math.sqrt(delta)) / (2*a);
                    const x2 = (-b - Math.sqrt(delta)) / (2*a);
                    return `x1: ${x1.toFixed(2)}, x2: ${x2.toFixed(2)}`;
                },
                format: (v) => v,
                getChartData: (v) => {
                    const [a, b, c] = v;
                    const rows = [['x', 'y']];
                    const vx = -b / (2*a);
                    const range = 10;
                    for(let x = vx - range; x <= vx + range; x+=1) {
                        const y = a*x*x + b*x + c;
                        rows.push([x, y]);
                    }
                    return { type: 'Line', data: rows, title: `Plot: y = ${a}x + ${b}x + ${c}` };
                }
            },
            pythagoras: {
                name: 'Pythagorean Theorem', l1: 'Side A', l2: 'Side B', inputs: 2,
                calc: (v) => Math.sqrt(v[0]*v[0] + v[1]*v[1]),
                format: (v) => `Hypotenuse: ${v.toFixed(2)}`,
                draw: (v, container) => {
                    const a = v[0], b = v[1];
                    const scale = 160 / Math.max(a, b);
                    const sa = a*scale, sb = b*scale;
                    const offX = (200-sb)/2, offY = (200-sa)/2;
                    return `<svg viewBox="0 0 200 200" class="w-full h-full"><polygon points="${offX},${200-offY} ${offX+sb},${200-offY} ${offX},${200-(offY+sa)}" fill="none" stroke="#3b82f6" stroke-width="2"/><rect x="${offX}" y="${200-offY-15}" width="15" height="15" fill="none" stroke="#64748b"/><text x="${offX-15}" y="${200-(offY+sa/2)}" fill="#64748b" font-size="12">a=${a}</text><text x="${offX+sb/2}" y="${200-offY+15}" fill="#64748b" font-size="12">b=${b}</text></svg>`;
                }
            }
        };

        // --- PHYSICS & FINANCE & HEALTH DATA (Unchanged) ---
        const PHYSICS_DATA = {
            speed: { name: 'Speed', l1: 'Dist (m)', l2: 'Time (s)', res: 'Speed (m/s)', calc: (a,b) => a/b },
            accel: { name: 'Acceleration', l1: ' Vel (m/s)', l2: 'Time (s)', res: 'Accel (m/s)', calc: (a,b) => a/b },
            force: { name: 'Force', l1: 'Mass (kg)', l2: 'Accel (m/s)', res: 'Force (N)', calc: (a,b) => a*b },
            work: { name: 'Work', l1: 'Force (N)', l2: 'Dist (m)', res: 'Work (J)', calc: (a,b) => a*b },
            power: { name: 'Power', l1: 'Work (J)', l2: 'Time (s)', res: 'Power (W)', calc: (a,b) => a/b },
            ke: { name: 'Kinetic Energy', l1: 'Mass (kg)', l2: 'Vel (m/s)', res: 'Energy (J)', calc: (a,b) => 0.5 * a * (b*b) }
        };

        const FINANCE_DATA = {
            loan: { name: 'Loan Payment', l1: 'Principal ($)', l2: 'Rate (%/yr)', l3: 'Term (Years)', res: 'Monthly Pmt ($)', inputs: 3, calc: (p, r, t) => { if(r === 0) return p / (t * 12); const i = (r / 100) / 12; const n = t * 12; return p * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1); }, getChartData: (p, r, t, res) => { const totalPaid = res * t * 12; let totalInterest = totalPaid - p; if (totalInterest < 0) totalInterest = 0; return { type: 'Pie', data: [['Type', 'Amount'], ['Principal', p], ['Interest', totalInterest]], title: 'Total Cost Breakdown' }; } },
            mortgage: { name: 'Mortgage', l1: 'Home Price ($)', l2: 'Rate (%/yr)', l3: 'Term (Years)', l4: 'Down Payment ($)', res: 'Monthly Pmt ($)', inputs: 4, calc: (p, r, t, down) => { const loan = p - down; if(loan <= 0) return 0; if(r === 0) return loan / (t * 12); const i = (r / 100) / 12; const n = t * 12; return loan * (i * Math.pow(1 + i, n)) / (Math.pow(1 + i, n) - 1); }, getChartData: (p, r, t, down, res) => { const loan = p - down; const totalPaid = res * t * 12; let totalInterest = totalPaid - loan; if (totalInterest < 0) totalInterest = 0; return { type: 'Pie', data: [['Type', 'Amount'], ['Down Payment', down], ['Loan Principal', loan], ['Total Interest', totalInterest]], title: 'Mortgage Cost Breakdown' }; } },
            compound: { name: 'Compound Interest', l1: 'Initial ($)', l2: 'Rate (%/yr)', l3: 'Time (Years)', l4: 'Monthly Dep ($)', res: 'Future Value ($)', inputs: 4, calc: (p, r, t, pmt) => { const n = 12; const rate = r / 100; const totalPeriods = t * 12; const fp = p * Math.pow(1 + rate/n, totalPeriods); const fd = pmt * (Math.pow(1 + rate/n, totalPeriods) - 1) / (rate/n); return fp + fd; }, getChartData: (p, r, t, pmt, res) => { const rows = [['Year', 'Balance']]; const n = 12; const rate = r/100; for(let y=0; y<=t; y++) { const periods = y*12; const bal = (p * Math.pow(1+rate/n, periods)) + (pmt * (Math.pow(1+rate/n, periods)-1)/(rate/n)); rows.push([y.toString(), bal]); } return { type: 'Line', data: rows, title: 'Growth Over Time' }; } },
            salary: { name: 'Simple Net Salary', l1: 'Gross Annual ($)', l2: 'Tax Rate (%)', l3: 'Deductions ($)', res: 'Net Monthly ($)', inputs: 3, calc: (gross, tax, ded) => { const taxAmt = gross * (tax / 100); const netAnnual = gross - taxAmt - ded; return netAnnual / 12; }, getChartData: (gross, tax, ded, res) => { const taxAmt = gross * (tax/100); let netAnnual = res * 12; if (netAnnual < 0) netAnnual = 0; return { type: 'Pie', data: [['Type', 'Amount'], ['Net Pay', netAnnual], ['Tax', taxAmt], ['Deductions', ded]], title: 'Annual Salary Breakdown' }; } },
            savings_goal: { name: 'Savings Goal', l1: 'Goal Amount ($)', l2: 'Current Saved ($)', l3: 'Rate (%/yr)', l4: 'Years to Grow', res: 'Monthly Need ($)', inputs: 4, calc: (goal, current, r, t) => { const n = 12; const rate = r / 100; const totalPeriods = t * 12; const fvPrincipal = current * Math.pow(1 + rate/n, totalPeriods); const remaining = goal - fvPrincipal; if(remaining <= 0) return 0; const denom = (Math.pow(1 + rate/n, totalPeriods) - 1) / (rate/n); return remaining / denom; }, getChartData: (goal, current, r, t, res) => { const rows = [['Year', 'Balance', 'Goal']]; const n = 12; const rate = r/100; for(let y=0; y<=t; y++) { const periods = y*12; const bal = (current * Math.pow(1+rate/n, periods)) + (res * (Math.pow(1+rate/n, periods)-1)/(rate/n)); rows.push([y.toString(), bal, goal]); } return { type: 'Line', data: rows, title: 'Progress to Goal' }; } },
            roi: { name: 'Investment Return', l1: 'Invested ($)', l2: 'Returned ($)', res: 'ROI (%)', inputs: 2, calc: (inv, ret) => ((ret - inv) / inv) * 100, getChartData: (inv, ret, res) => { const profit = ret - inv; const isLoss = profit < 0; return { type: 'Bar', data: [['Type', 'Amount', { role: 'style' }], ['Invested', inv, '#3b82f6'], [isLoss ? 'Loss' : 'Profit', Math.abs(profit), isLoss ? '#ef4444' : '#22c55e']], title: 'ROI Analysis' }; } }
        };

        const HEALTH_DATA = {
            bmi: { name: 'BMI Calculator', l1: 'Weight (kg)', l2: 'Height (cm)', inputs: 2, showGender: false, showActivity: false, calc: (vals) => { const h = vals[1]/100; return vals[0] / (h*h); }, format: (v) => `${v.toFixed(1)} BMI`, getChartData: (vals, g, act, date, res) => { const gauge = { type: 'Gauge', data: [['Label', 'Value'], ['BMI', parseFloat(res.toFixed(1))]], title: 'BMI Score', max: 40, redFrom: 30, redTo: 40, yellowFrom: 25, yellowTo: 30, greenFrom: 18.5, greenTo: 25 }; const bar = { type: 'Bar', data: [['Category', 'BMI'], ['Underweight', 18.5], ['Normal', 24.9], ['Overweight', 29.9], ['You', parseFloat(res.toFixed(1))]], title: 'BMI Comparison' }; return [gauge, bar]; } },
            bmr: { name: 'BMR (Mifflin-St Jeor)', l1: 'Weight (kg)', l2: 'Height (cm)', l3: 'Age', inputs: 3, showGender: true, showActivity: false, calc: (vals, g) => { const s = g === 'male' ? 5 : -161; return (10*vals[0]) + (6.25*vals[1]) - (5*vals[2]) + s; }, format: (v) => `${Math.round(v)} kcal/day`, getChartData: (vals, g, act, date, res) => { return null; } },
            tdee: { name: 'Calorie Intake (TDEE)', l1: 'Weight (kg)', l2: 'Height (cm)', l3: 'Age', inputs: 3, showGender: true, showActivity: true, calc: (vals, g, act) => { const s = g === 'male' ? 5 : -161; const bmr = (10*vals[0]) + (6.25*vals[1]) - (5*vals[2]) + s; return bmr * act; }, format: (v) => `${Math.round(v)} kcal/day`, getChartData: (vals, g, act, date, res) => { const s = g === 'male' ? 5 : -161; const bmr = (10*vals[0]) + (6.25*vals[1]) - (5*vals[2]) + s; const burn = res - bmr; const pie = { type: 'Pie', data: [['Source', 'Calories'], ['BMR (Exist)', bmr], ['Activity (Burn)', burn]], title: 'Energy Expenditure' }; const bar = { type: 'Bar', data: [['Goal', 'Calories'], ['Cut', res-500], ['Maintain', res], ['Bulk', res+500]], title: 'Goal Targets' }; return [pie, bar]; } },
            body_fat: { name: 'Body Fat % (Navy)', l1: 'Height (cm)', l2: 'Neck (cm)', l3: 'Waist (cm)', l4: 'Hip (cm, F only)', inputs: 4, showGender: true, showActivity: false, calc: (vals, g) => { if(g === 'male') return 495 / (1.0324 - 0.19077 * Math.log10(vals[2] - vals[1]) + 0.15456 * Math.log10(vals[0])) - 450; else return 495 / (1.29579 - 0.35004 * Math.log10(vals[2] + vals[3] - vals[1]) + 0.22100 * Math.log10(vals[0])) - 450; }, format: (v) => `${v.toFixed(1)}% Fat`, getChartData: (vals, g, act, date, res) => { const gauge = { type: 'Gauge', data: [['Label', 'Value'], ['Body Fat', parseFloat(res.toFixed(1))]], title: 'Body Fat %', max: 50, redFrom: 25, redTo: 50, yellowFrom: 18, yellowTo: 25, greenFrom: 6, greenTo: 18 }; return [gauge]; } }
        };

        const UNIT_DATA = {
            Currency: { base: 'USD', units: { 'USD': { name: 'US Dollar', factor: 1 }, 'EUR': { name: 'Euro', factor: 0.92 }, 'GBP': { name: 'British Pound', factor: 0.79 }, 'JPY': { name: 'Japanese Yen', factor: 150 }, 'CAD': { name: 'Canadian Dollar', factor: 1.35 }, 'AUD': { name: 'Australian Dollar', factor: 1.52 }, 'INR': { name: 'Indian Rupee', factor: 83 }, 'CNY': { name: 'Chinese Yuan', factor: 7.2 } } },
            Length: { base: 'm', units: { 'm': { name: 'Meters', factor: 1 }, 'km': { name: 'Kilometers', factor: 1000 }, 'cm': { name: 'Centimeters', factor: 0.01 }, 'mm': { name: 'Millimeters', factor: 0.001 }, 'mi': { name: 'Miles', factor: 1609.34 }, 'yd': { name: 'Yards', factor: 0.9144 }, 'ft': { name: 'Feet', factor: 0.3048 }, 'in': { name: 'Inches', factor: 0.0254 } } },
            Weight: { base: 'kg', units: { 'kg': { name: 'Kilograms', factor: 1 }, 'g': { name: 'Grams', factor: 0.001 }, 'mg': { name: 'Milligrams', factor: 0.000001 }, 'lb': { name: 'Pounds', factor: 0.453592 }, 'oz': { name: 'Ounces', factor: 0.0283495 }, 'st': { name: 'Stone', factor: 6.35029 }, 't': { name: 'Metric Ton', factor: 1000 } } },
            Temperature: { type: 'special', units: { 'C': { name: 'Celsius', toBase: v => v, fromBase: v => v }, 'F': { name: 'Fahrenheit', toBase: v => (v - 32) * 5/9, fromBase: v => (v * 9/5) + 32 }, 'K': { name: 'Kelvin', toBase: v => v - 273.15, fromBase: v => v + 273.15 } } },
            Volume: { base: 'l', units: { 'l': { name: 'Liters', factor: 1 }, 'ml': { name: 'Milliliters', factor: 0.001 }, 'gal': { name: 'Gallons (US)', factor: 3.78541 }, 'qt': { name: 'Quarts (US)', factor: 0.946353 }, 'pt': { name: 'Pints (US)', factor: 0.473176 }, 'cup': { name: 'Cups', factor: 0.24 } } }
        };

        // --- CHART & UI FUNCTIONS ---
        function initCharts() {
            google.charts.load('current', {'packages':['corechart', 'gauge']});
            window.addEventListener('resize', () => {
                if(window.lastFinanceChartData && document.getElementById('view-finance').style.display !== 'none') drawFinanceCharts(window.lastFinanceChartData);
                if(window.lastHealthChartData && document.getElementById('view-health').style.display !== 'none') drawHealthCharts(window.lastHealthChartData);
                if(window.lastMathChartData && document.getElementById('view-math').style.display !== 'none') drawMathCharts(window.lastMathChartData);
                if(window.lastChemChartData && document.getElementById('view-chem').style.display !== 'none') drawChemCharts(window.lastChemChartData);
                if(window.lastEngChartData && document.getElementById('view-eng').style.display !== 'none') drawEngCharts(window.lastEngChartData);
            });
        }

        // Generic Chart Drawer
        function drawGenericChart(containerId, chartData, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const data = google.visualization.arrayToDataTable(chartData.data);
            const options = {
                title: chartData.title,
                backgroundColor: 'transparent',
                titleTextStyle: { color: '#64748b', fontSize: 14 },
                legend: { position: 'bottom', textStyle: { color: '#64748b' } },
                width: '100%', height: '100%',
                chartArea: { width: '85%', height: '75%' }
            };
            if(document.documentElement.classList.contains('dark')) {
                options.titleTextStyle.color = '#cbd5e1';
                options.legend.textStyle.color = '#cbd5e1';
                if(options.hAxis) options.hAxis = { textStyle: { color: '#cbd5e1' } }; else options.hAxis = { textStyle: { color: '#cbd5e1' } };
                if(options.vAxis) options.vAxis = { textStyle: { color: '#cbd5e1' } }; else options.vAxis = { textStyle: { color: '#cbd5e1' } };
            }
            let chart;
            if (chartData.type === 'Pie') chart = new google.visualization.PieChart(container);
            else if (chartData.type === 'Line') chart = new google.visualization.LineChart(container);
            else if (chartData.type === 'Bar') chart = new google.visualization.ColumnChart(container);
            else if (chartData.type === 'Gauge') {
                Object.assign(options, { redFrom: chartData.redFrom, redTo: chartData.redTo, yellowFrom: chartData.yellowFrom, yellowTo: chartData.yellowTo, greenFrom: chartData.greenFrom, greenTo: chartData.greenTo, max: chartData.max, minorTicks: 5 });
                chart = new google.visualization.Gauge(container);
            }
            if(chart) chart.draw(data, options);
        }

        function drawFinanceCharts(chartData) {
            if(!chartData || !google.visualization) return;
            window.lastFinanceChartData = chartData;
            drawGenericChart('fin-chart-1', chartData);
            document.getElementById('fin-chart-1').style.display = 'block';
            document.getElementById('fin-chart-2').style.display = 'none';
        }

        function drawHealthCharts(chartDataArray) {
            if(!chartDataArray || !google.visualization) return;
            window.lastHealthChartData = chartDataArray;
            document.getElementById('health-chart-1').innerHTML = '';
            document.getElementById('health-chart-2').innerHTML = '';
            chartDataArray.forEach((d, i) => {
                if(!d) return;
                const cid = i===0 ? 'health-chart-1' : 'health-chart-2';
                drawGenericChart(cid, d);
                document.getElementById(cid).style.display = 'block';
            });
        }

        function drawMathCharts(chartData) {
            if(!chartData || !google.visualization) return;
            window.lastMathChartData = chartData;
            window.lastMathSVG = null;
            drawGenericChart('math-chart-1', chartData);
            document.getElementById('math-chart-1').style.display = 'block';
        }

        function drawMathSVG(svgString) {
            window.lastMathSVG = svgString;
            window.lastMathChartData = null;
            const container = document.getElementById('math-chart-1');
            container.innerHTML = svgString;
            container.style.display = 'block';
        }

        function drawChemCharts(chartData) {
            if(!chartData || !google.visualization) return;
            window.lastChemChartData = chartData;
            window.lastChemSVG = null;
            drawGenericChart('chem-chart-1', chartData);
            document.getElementById('chem-chart-1').style.display = 'block';
        }

        function drawChemSVG(svgString) {
            window.lastChemSVG = svgString;
            window.lastChemChartData = null;
            const container = document.getElementById('chem-chart-1');
            container.innerHTML = svgString;
            container.style.display = 'block';
        }

        function drawEngCharts(chartData) {
            if(!chartData || !google.visualization) return;
            window.lastEngChartData = chartData;
            window.lastEngSVG = null;
            drawGenericChart('eng-chart-1', chartData);
            document.getElementById('eng-chart-1').style.display = 'block';
        }

        function drawEngSVG(svgString) {
            window.lastEngSVG = svgString;
            window.lastEngChartData = null;
            const container = document.getElementById('eng-chart-1');
            container.innerHTML = svgString;
            container.style.display = 'block';
        }

        // --- ENG INITIALIZATION ---
        function initEng() {
            const select = document.getElementById('eng-formula');
            Object.keys(ENG_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = ENG_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateEngUI);
            updateEngUI();
        }

        function updateEngUI() {
            const key = document.getElementById('eng-formula').value;
            const data = ENG_DATA[key];
            const count = data.inputs;

            document.getElementById('eng-label-1').textContent = data.l1 || 'Input 1';
            document.getElementById('eng-label-2').textContent = data.l2 || 'Input 2';
            
            document.getElementById('eng-input-group-2').style.display = count >= 2 ? 'block' : 'none';
            document.getElementById('eng-input-group-3').style.display = count >= 3 ? 'block' : 'none';
            if(count >= 3) document.getElementById('eng-label-3').textContent = data.l3;
            document.getElementById('eng-input-group-4').style.display = count >= 4 ? 'block' : 'none';
            if(count >= 4) document.getElementById('eng-label-4').textContent = data.l4;

            document.getElementById('eng-label-result').textContent = 'Result';
            document.getElementById('eng-result').value = '';
            document.getElementById('eng-chart-1').innerHTML = '';
        }

        window.calculateEng = function() {
            const key = document.getElementById('eng-formula').value;
            const data = ENG_DATA[key];
            const vals = [];
            for(let i=1; i<=data.inputs; i++) {
                const v = parseFloat(document.getElementById(`eng-input-${i}`).value);
                if(isNaN(v)) { document.getElementById('eng-result').value = "Invalid Input"; return; }
                vals.push(v);
            }

            const rawRes = data.calc(vals);
            const formatted = data.format(rawRes);
            document.getElementById('eng-result').value = formatted;

            if (data.getChartData) {
                const chartData = data.getChartData(vals);
                if(chartData) google.charts.setOnLoadCallback(() => drawEngCharts(chartData));
                else document.getElementById('eng-chart-1').innerHTML = '';
            } else if (data.draw) {
                const svg = data.draw(vals);
                drawEngSVG(svg);
            }

            saveToHistory(vals.join(', '), '', formatted, '', 'Eng: ' + data.name);
        };

        // --- MATH INITIALIZATION ---
        function initMath() {
            const select = document.getElementById('math-formula');
            Object.keys(MATH_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = MATH_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateMathUI);
            updateMathUI();
        }

        function updateMathUI() {
            const key = document.getElementById('math-formula').value;
            const data = MATH_DATA[key];
            const count = data.inputs;

            document.getElementById('math-label-1').textContent = data.l1 || 'Input 1';
            document.getElementById('math-label-2').textContent = data.l2 || 'Input 2';
            
            // Show/Hide Inputs
            document.getElementById('math-input-group-2').style.display = count >= 2 ? 'block' : 'none';
            document.getElementById('math-input-group-3').style.display = count >= 3 ? 'block' : 'none';
            if(count >= 3) document.getElementById('math-label-3').textContent = data.l3;

            document.getElementById('math-label-result').textContent = 'Result';
            document.getElementById('math-result').value = '';
            document.getElementById('math-chart-1').innerHTML = '';
        }

        window.calculateMath = function() {
            const key = document.getElementById('math-formula').value;
            const data = MATH_DATA[key];
            const vals = [];
            for(let i=1; i<=data.inputs; i++) {
                const v = parseFloat(document.getElementById(`math-input-${i}`).value);
                if(isNaN(v)) { document.getElementById('math-result').value = "Invalid Input"; return; }
                vals.push(v);
            }

            const rawRes = data.calc(vals);
            const formatted = data.format(rawRes);
            document.getElementById('math-result').value = formatted;

            // DRAWING LOGIC SWITCH
            if (data.getChartData) {
                const chartData = data.getChartData(vals);
                google.charts.setOnLoadCallback(() => drawMathCharts(chartData));
            } else if (data.draw) {
                const svg = data.draw(vals);
                drawMathSVG(svg);
            }

            saveToHistory(vals.join(', '), '', formatted, '', 'Math: ' + data.name);
        };

        // --- CHEM INITIALIZATION ---
        function initChem() {
            const select = document.getElementById('chem-formula');
            Object.keys(CHEM_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = CHEM_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateChemUI);
            updateChemUI();
        }

        function updateChemUI() {
            const key = document.getElementById('chem-formula').value;
            const data = CHEM_DATA[key];
            const count = data.inputs;

            document.getElementById('chem-label-1').textContent = data.l1 || 'Input 1';
            document.getElementById('chem-label-2').textContent = data.l2 || 'Input 2';
            
            // Show/Hide Inputs
            const showText = !!data.showText;
            document.getElementById('chem-input-text-group').style.display = showText ? 'block' : 'none';
            if(showText && data.l1 === '') document.getElementById('chem-label-text').textContent = 'Chemical Formula';

            document.getElementById('chem-input-group-1').style.display = (!showText && count >= 1) ? 'block' : 'none';
            document.getElementById('chem-input-group-2').style.display = (!showText && count >= 2) ? 'block' : 'none';
            document.getElementById('chem-input-group-3').style.display = (!showText && count >= 3) ? 'block' : 'none';
            
            if(!showText && count >= 3) document.getElementById('chem-label-3').textContent = data.l3;

            document.getElementById('chem-label-result').textContent = 'Result';
            document.getElementById('chem-result').value = '';
            document.getElementById('chem-chart-1').innerHTML = '';
        }

        window.calculateChem = function() {
            const key = document.getElementById('chem-formula').value;
            const data = CHEM_DATA[key];
            const vals = [];
            let textVal = '';

            if (data.showText) {
                textVal = document.getElementById('chem-input-text').value.trim();
                if(!textVal) { document.getElementById('chem-result').value = "Enter Formula"; return; }
            } else {
                for(let i=1; i<=data.inputs; i++) {
                    const v = parseFloat(document.getElementById(`chem-input-${i}`).value);
                    if(isNaN(v)) { document.getElementById('chem-result').value = "Invalid Input"; return; }
                    vals.push(v);
                }
            }

            const rawRes = data.calc(vals, textVal);
            const formatted = data.format(rawRes);
            document.getElementById('chem-result').value = formatted;

            // DRAWING LOGIC SWITCH
            if (data.getChartData) {
                const chartData = data.getChartData(vals, textVal);
                if(chartData) google.charts.setOnLoadCallback(() => drawChemCharts(chartData));
                else document.getElementById('chem-chart-1').innerHTML = '';
            } else if (data.draw) {
                const svg = data.draw(vals);
                drawChemSVG(svg);
            }

            const inp = data.showText ? textVal : vals.join(', ');
            saveToHistory(inp, '', formatted, '', 'Chem: ' + data.name);
        };

        // --- OTHER INITS ---
        function initPhysics() {
            const select = document.getElementById('physics-formula');
            Object.keys(PHYSICS_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = PHYSICS_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updatePhysicsUI);
            updatePhysicsUI();
        }
        function updatePhysicsUI() {
            const key = document.getElementById('physics-formula').value;
            const data = PHYSICS_DATA[key];
            document.getElementById('phys-label-1').textContent = data.l1;
            document.getElementById('phys-label-2').textContent = data.l2;
            document.getElementById('phys-label-result').textContent = data.res;
            document.getElementById('phys-result').value = '';
        }
        function initFinance() {
            const select = document.getElementById('finance-formula');
            Object.keys(FINANCE_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = FINANCE_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateFinanceUI);
            updateFinanceUI();
        }
        function updateFinanceUI() {
            const key = document.getElementById('finance-formula').value;
            const data = FINANCE_DATA[key];
            const count = data.inputs;
            if(count >= 1) document.getElementById('fin-label-1').textContent = data.l1;
            if(count >= 2) document.getElementById('fin-label-2').textContent = data.l2;
            const g3 = document.getElementById('fin-input-group-3');
            if (count >= 3) { g3.style.display = 'block'; document.getElementById('fin-label-3').textContent = data.l3; } else { g3.style.display = 'none'; }
            const g4 = document.getElementById('fin-input-group-4');
            if (count >= 4) { g4.classList.remove('hidden'); document.getElementById('fin-label-4').textContent = data.l4; } else { g4.classList.add('hidden'); }
            document.getElementById('fin-label-result').textContent = data.res;
            document.getElementById('fin-result').value = '';
            document.getElementById('fin-chart-1').innerHTML = '';
            document.getElementById('fin-chart-2').innerHTML = '';
        }
        function initHealth() {
            const select = document.getElementById('health-formula');
            Object.keys(HEALTH_DATA).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key; opt.textContent = HEALTH_DATA[key].name;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateHealthUI);
            updateHealthUI();
        }
        function updateHealthUI() {
            const key = document.getElementById('health-formula').value;
            const data = HEALTH_DATA[key];
            document.getElementById('health-gender-group').style.display = data.showGender ? 'block' : 'none';
            document.getElementById('health-activity-group').style.display = data.showActivity ? 'block' : 'none';
            document.getElementById('health-date-group').classList.toggle('hidden', !data.showDate);
            document.getElementById('health-inputs-container').style.display = data.inputs > 0 ? 'block' : 'none';
            if(data.inputs >= 1) document.getElementById('health-label-1').textContent = data.l1;
            if(data.inputs >= 2) document.getElementById('health-label-2').textContent = data.l2;
            if(data.inputs >= 3) { document.getElementById('health-input-group-3').classList.remove('hidden'); document.getElementById('health-label-3').textContent = data.l3; } else { document.getElementById('health-input-group-3').classList.add('hidden'); }
            if(data.inputs >= 4) { document.getElementById('health-input-group-4').classList.remove('hidden'); document.getElementById('health-label-4').textContent = data.l4; } else { document.getElementById('health-input-group-4').classList.add('hidden'); }
            document.getElementById('health-result').value = '';
            document.getElementById('health-chart-1').innerHTML = '';
            document.getElementById('health-chart-2').innerHTML = '';
        }

        // --- CALCULATION HANDLERS ---
        window.calculatePhysics = function() {
            const key = document.getElementById('physics-formula').value;
            const v1 = parseFloat(document.getElementById('phys-input-1').value);
            const v2 = parseFloat(document.getElementById('phys-input-2').value);
            if (isNaN(v1) || isNaN(v2)) { document.getElementById('phys-result').value = "Invalid Input"; return; }
            const result = PHYSICS_DATA[key].calc(v1, v2);
            let formatted = (Math.abs(result) < 0.001 || Math.abs(result) > 10000) ? result.toExponential(3) : parseFloat(result.toFixed(4));
            document.getElementById('phys-result').value = formatted;
            saveToHistory(v1 + ', ' + v2, '', formatted, '', 'Physics: ' + PHYSICS_DATA[key].name);
        };
        window.calculateFinance = function() {
            const key = document.getElementById('finance-formula').value;
            const data = FINANCE_DATA[key];
            const v1 = parseFloat(document.getElementById('fin-input-1').value);
            const v2 = parseFloat(document.getElementById('fin-input-2').value);
            const v3 = (data.inputs >= 3) ? parseFloat(document.getElementById('fin-input-3').value) : 0;
            const v4 = (data.inputs >= 4) ? parseFloat(document.getElementById('fin-input-4').value) : 0;
            if (isNaN(v1) || isNaN(v2) || (data.inputs >= 3 && isNaN(v3)) || (data.inputs >= 4 && isNaN(v4))) { document.getElementById('fin-result').value = "Invalid Input"; return; }
            const result = data.calc(v1, v2, v3, v4);
            const formatted = parseFloat(result.toFixed(2)); 
            document.getElementById('fin-result').value = formatted;
            if (data.getChartData) {
                const chartData = data.getChartData(v1, v2, v3, v4, result);
                google.charts.setOnLoadCallback(() => drawFinanceCharts(chartData));
            }
            saveToHistory([v1,v2,v3,v4].slice(0, data.inputs).join(', '), '', formatted, '', 'Finance: ' + data.name);
        };
        window.calculateHealth = function() {
            const key = document.getElementById('health-formula').value;
            const data = HEALTH_DATA[key];
            const vals = [];
            for(let i=1; i<=data.inputs; i++) {
                const v = parseFloat(document.getElementById(`health-input-${i}`).value);
                if(isNaN(v)) { document.getElementById('health-result').value = "Invalid Input"; return; }
                vals.push(v);
            }
            const gender = document.getElementById('health-gender').value;
            const activity = parseFloat(document.getElementById('health-activity').value);
            const dateStr = document.getElementById('health-date').value;
            if(data.showDate && !dateStr) { document.getElementById('health-result').value = "Select Date"; return; }
            const rawRes = data.calc(vals, gender, activity, dateStr);
            const formatted = data.format(rawRes);
            document.getElementById('health-result').value = formatted;
            if (data.getChartData) {
                const chartData = data.getChartData(vals, gender, activity, dateStr, rawRes);
                google.charts.setOnLoadCallback(() => drawHealthCharts(chartData));
            }
            saveToHistory(vals.join(', '), '', formatted, '', 'Health: ' + data.name);
        };

        // --- CONVERTER LOGIC (Unchanged but compact) ---
        async function fetchCurrencyRates() {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await res.json();
                if(data && data.rates) {
                    const newUnits = {};
                    ['USD','EUR','GBP','JPY','CAD','AUD','INR','CNY'].forEach(c => { if(data.rates[c]) newUnits[c] = { name: c, factor: data.rates[c] }; });
                    UNIT_DATA['Currency'].units = newUnits;
                    if(document.getElementById('category-select').value === 'Currency') updateUnits();
                }
            } catch(e) { console.error("Failed to fetch rates", e); }
        }
        function updateUnits(reset = false) {
            const cat = document.getElementById('category-select').value;
            const units = UNIT_DATA[cat].units;
            const from = document.getElementById('from-unit');
            const to = document.getElementById('to-unit');
            from.innerHTML = ''; to.innerHTML = '';
            Object.keys(units).forEach(k => {
                const opt = (val, txt) => { const o = document.createElement('option'); o.value = val; o.textContent = txt; return o; };
                from.appendChild(opt(k, units[k].name)); to.appendChild(opt(k, units[k].name));
            });
            if (reset && Object.keys(units).length > 1) to.value = Object.keys(units)[1];
            calculateConverter();
        }
        window.calculateConverter = function() { // Renamed slightly to avoid clash
            const cat = document.getElementById('category-select').value;
            const val = parseFloat(document.getElementById('input-value').value);
            if (isNaN(val)) { document.getElementById('output-value').value = ''; return; }
            const fU = document.getElementById('from-unit').value;
            const tU = document.getElementById('to-unit').value;
            const d = UNIT_DATA[cat];
            let res;
            if (d.type === 'special') {
                res = d.units[tU].fromBase(d.units[fU].toBase(val));
            } else {
                if(cat === 'Currency') res = (val / d.units[fU].factor) * d.units[tU].factor;
                else res = val * (d.units[fU].factor / d.units[tU].factor);
            }
            const fmt = (Math.abs(res) < 1e-6 && res!==0) ? res.toExponential(4) : parseFloat(res.toPrecision(6));
            document.getElementById('output-value').value = fmt;
            saveToHistory(val, fU, fmt, tU, cat);
        }
        document.getElementById('category-select').addEventListener('change', () => updateUnits(true));
        document.getElementById('from-unit').addEventListener('change', calculateConverter);
        document.getElementById('to-unit').addEventListener('change', calculateConverter);
        document.getElementById('input-value').addEventListener('input', calculateConverter);
        document.getElementById('swap-btn').addEventListener('click', () => {
            const f = document.getElementById('from-unit'); const t = document.getElementById('to-unit');
            const tmp = f.value; f.value = t.value; t.value = tmp; calculateConverter();
        });

        // --- HISTORY & STATE ---
        let currentUser = null;
        let saveTimeout;
        function saveToHistory(inVal, inUnit, outVal, outUnit, cat) {
            if (!currentUser) return;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (inVal === '' || (typeof inVal === 'number' && isNaN(inVal))) return;
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUser.uid}/conversion_results`), {
                        inputVal: inVal, inputUnit: inUnit, outputVal: outVal, outputUnit: outUnit, category: cat, timestamp: serverTimestamp()
                    });
                } catch (err) { console.error("Error saving history:", err); }
            }, 1500);
        }

        let unsubscribeHistory = null;
        let currentHistoryIds = [];
        const clearBtns = [
            document.getElementById('clear-history'), document.getElementById('phys-clear-history'),
            document.getElementById('fin-clear-history'), document.getElementById('health-clear-history'),
            document.getElementById('math-clear-history'), document.getElementById('chem-clear-history'),
            document.getElementById('eng-clear-history')
        ];
        
        // Wire up print buttons
        document.querySelectorAll('button[id$="print-history"]').forEach(b => b.addEventListener('click', () => { window.focus(); window.print(); }));

        // Wire up clear buttons
        clearBtns.forEach(b => b.addEventListener('click', handleClearHistoryClick));

        function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('auth-text').textContent = `ID: ${user.uid.slice(0, 6)}...`;
                    document.getElementById('auth-dot').className = "w-2 h-2 bg-green-500 rounded-full mr-2";
                    setupHistoryListener(user.uid);
                } else {
                    signInAnonymously(auth).catch(e => console.error("Auth failed", e));
                }
            });
        }

        function setupHistoryListener(uid) {
            unsubscribeHistory = onSnapshot(collection(db, `artifacts/${appId}/users/${uid}/conversion_results`), (snapshot) => {
                const data = [];
                snapshot.forEach(d => data.push({ id: d.id, ...d.data() }));
                currentHistoryIds = data.map(i => i.id);
                data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                
                // Render to ALL lists with filtering
                renderHistoryList('history-list', data); // All
                renderHistoryList('phys-history-list', data.filter(i => i.category.startsWith('Physics')));
                renderHistoryList('fin-history-list', data.filter(i => i.category.startsWith('Finance')));
                renderHistoryList('health-history-list', data.filter(i => i.category.startsWith('Health')));
                renderHistoryList('math-history-list', data.filter(i => i.category.startsWith('Math')));
                renderHistoryList('chem-history-list', data.filter(i => i.category.startsWith('Chem')));
                renderHistoryList('eng-history-list', data.filter(i => i.category.startsWith('Eng')));

                const isEmpty = data.length === 0;
                clearBtns.forEach(b => {
                    b.disabled = isEmpty;
                    b.classList.toggle('opacity-50', isEmpty);
                });
                
                // Toggle empty states
                toggleEmpty('history', data.length === 0);
                toggleEmpty('phys-history', data.filter(i => i.category.startsWith('Physics')).length === 0);
                toggleEmpty('fin-history', data.filter(i => i.category.startsWith('Finance')).length === 0);
                toggleEmpty('health-history', data.filter(i => i.category.startsWith('Health')).length === 0);
                toggleEmpty('math-history', data.filter(i => i.category.startsWith('Math')).length === 0);
                toggleEmpty('chem-history', data.filter(i => i.category.startsWith('Chem')).length === 0);
                toggleEmpty('eng-history', data.filter(i => i.category.startsWith('Eng')).length === 0);
            });
        }

        function toggleEmpty(prefix, isEmpty) {
            document.getElementById(`${prefix}-loading`).classList.add('hidden');
            document.getElementById(`${prefix}-empty`).classList.toggle('hidden', !isEmpty);
        }

        function renderHistoryList(elementId, items) {
            const list = document.getElementById(elementId);
            list.innerHTML = '';
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors group border border-transparent hover:border-slate-200 dark:hover:border-slate-600';
                
                // Determine display units
                let fromUnit = item.inputUnit, toUnit = item.outputUnit;
                if(UNIT_DATA[item.category] && UNIT_DATA[item.category].units[fromUnit]) fromUnit = UNIT_DATA[item.category].units[fromUnit].name;
                if(UNIT_DATA[item.category] && UNIT_DATA[item.category].units[toUnit]) toUnit = UNIT_DATA[item.category].units[toUnit].name;

                el.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-baseline gap-2">
                            <span class="font-bold text-slate-700 dark:text-slate-200 truncate">${item.inputVal} <span class="text-xs font-normal text-slate-500">${fromUnit}</span></span>
                            <i class="fa-solid fa-arrow-right text-[10px] text-slate-400"></i>
                            <span class="font-bold text-brand-600 dark:text-brand-400 truncate">${item.outputVal} <span class="text-xs font-normal text-brand-500/70">${toUnit}</span></span>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-0.5"><span class="uppercase tracking-wider font-semibold border border-slate-200 dark:border-slate-600 px-1 rounded">${item.category}</span></div>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 transition-opacity text-slate-400 hover:text-red-500 p-2" onclick="window.deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                `;
                list.appendChild(el);
            });
        }

        window.deleteItem = async (id) => { if(currentUser) await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/conversion_results`, id)); };
        
        let clearTimer;
        async function handleClearHistoryClick(e) {
            const btn = e.target;
            const isConfirming = btn.getAttribute('data-confirming') === 'true';
            if (isConfirming) {
                if(currentUser && currentHistoryIds.length > 0) {
                    const batch = currentHistoryIds.map(id => deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/conversion_results`, id)));
                    await Promise.all(batch);
                }
                clearBtns.forEach(b => { b.innerText = "Clear All"; b.removeAttribute('data-confirming'); b.classList.remove('bg-red-500', 'text-white'); });
            } else {
                clearBtns.forEach(b => { b.innerText = "Confirm?"; b.setAttribute('data-confirming', 'true'); b.classList.add('bg-red-500', 'text-white'); });
                clearTimeout(clearTimer);
                clearTimer = setTimeout(() => {
                    clearBtns.forEach(b => { b.innerText = "Clear All"; b.removeAttribute('data-confirming'); b.classList.remove('bg-red-500', 'text-white'); });
                }, 3000);
            }
        }
        
        window.copyResult = function() {
            const output = document.getElementById('output-value');
            if (output.value) {
                const el = document.createElement('textarea');
                el.value = output.value; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                const icon = document.getElementById('copy-icon');
                if(icon) { icon.classList.replace('fa-regular', 'fa-solid'); icon.classList.replace('fa-copy', 'fa-check'); icon.classList.add('text-green-500'); setTimeout(() => { icon.classList.replace('fa-solid', 'fa-regular'); icon.classList.replace('fa-check', 'fa-copy'); icon.classList.remove('text-green-500'); }, 1000); }
            }
        };

        // Initialize UI
        Object.keys(UNIT_DATA).forEach(cat => { const o = document.createElement('option'); o.value = cat; o.textContent = cat; document.getElementById('category-select').appendChild(o); });
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); });

        initPhysics(); initFinance(); initHealth(); initMath(); initChem(); initEng();
        initCharts(); initAuth(); updateUnits(true); fetchCurrencyRates();
        switchView('home');

    </script>
</body>
</html>
